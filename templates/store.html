<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Probador Virtual</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#c9a55a">
    <meta name="mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a; --bg2: #141414; --card: #1a1a1a;
            --border: #2a2520; --border-light: #3a3530;
            --accent: #c9a55a; --accent-soft: rgba(201,165,90,0.15);
            --text: #f0ece4; --text2: #8a8578; --text3: #5a554e;
            --success: #4ade80; --danger: #ef4444;
            --radius: 12px;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

        /* Header */
        .header {
            background:var(--bg2); border-bottom:1px solid var(--border);
            padding:0.8rem 1.2rem; display:flex; align-items:center; justify-content:center;
            position:sticky; top:0; z-index:100;
        }
        .header h1 {
            font-family:'Playfair Display',serif; font-size:1.2rem; font-weight:600;
            background:linear-gradient(135deg, var(--accent), #e8d5a3);
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
        }

        .container { max-width:600px; margin:0 auto; padding:1rem; }

        /* Steps */
        .steps { display:flex; justify-content:center; gap:0.3rem; margin:1rem 0 1.5rem; }
        .step {
            width:10px; height:10px; border-radius:50%;
            background:var(--border); transition:all 0.3s;
        }
        .step.active { background:var(--accent); width:28px; border-radius:5px; }
        .step.done { background:var(--success); }

        /* Sections */
        .section { display:none; }
        .section.active { display:block; animation:fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

        .section-title {
            font-family:'Playfair Display',serif; font-size:1.4rem;
            font-weight:700; margin-bottom:0.3rem;
        }
        .section-sub { color:var(--text2); font-size:0.85rem; margin-bottom:1.2rem; }

        /* Cards */
        .card {
            background:var(--bg2); border:1px solid var(--border);
            border-radius:var(--radius); padding:1.2rem; margin-bottom:1rem;
        }
        .card-title { font-weight:600; margin-bottom:0.8rem; font-size:0.95rem; }

        /* Gender */
        .gender-opts { display:flex; gap:0.75rem; }
        .gender-opt {
            flex:1; padding:1.2rem; text-align:center; border-radius:var(--radius);
            border:2px solid var(--border); background:var(--bg); cursor:pointer;
            transition:all 0.3s; font-family:inherit; color:var(--text);
        }
        .gender-opt.selected { border-color:var(--accent); background:var(--accent-soft); }
        .gender-opt .icon { font-size:2rem; margin-bottom:0.3rem; }
        .gender-opt .label { font-size:0.85rem; font-weight:500; }

        /* Form */
        .form-row { display:flex; gap:0.75rem; margin-top:1rem; }
        .form-row .field { flex:1; }
        .form-row label { display:block; font-size:0.8rem; color:var(--text2); margin-bottom:4px; }
        .form-row input, .form-row select {
            width:100%; padding:10px 12px; background:var(--bg); border:1px solid var(--border);
            border-radius:8px; color:var(--text); font-family:inherit; font-size:0.95rem;
        }

        /* Size result */
        .size-result {
            display:none; text-align:center; margin-top:1rem;
            padding:1rem; background:var(--accent-soft); border-radius:var(--radius);
        }
        .size-result.visible { display:block; }
        .size-big { font-size:2.5rem; font-weight:700; color:var(--accent); }

        /* Garments grid */
        .garments { display:grid; grid-template-columns:repeat(2,1fr); gap:0.75rem; }
        .garment {
            background:var(--card); border:2px solid var(--border); border-radius:var(--radius);
            overflow:hidden; cursor:pointer; transition:all 0.3s; position:relative;
        }
        .garment.selected { border-color:var(--accent); box-shadow:0 0 0 1px var(--accent); }
        .garment img { width:100%; height:160px; object-fit:cover; background:#111; }
        .garment .info { padding:0.6rem 0.8rem; }
        .garment .name { font-weight:600; font-size:0.85rem; }
        .garment .meta { font-size:0.75rem; color:var(--text2); margin-top:2px; }
        .garment .price { color:var(--accent); font-weight:600; font-size:0.85rem; margin-top:2px; }
        .garment .check {
            position:absolute; top:8px; right:8px; width:24px; height:24px;
            background:var(--accent); border-radius:50%; display:none;
            align-items:center; justify-content:center; color:#0a0a0a; font-size:0.8rem; font-weight:700;
        }
        .garment.selected .check { display:flex; }

        /* Filters */
        .filters { display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap; }
        .filter-btn {
            padding:6px 14px; border-radius:20px; border:1px solid var(--border);
            background:transparent; color:var(--text2); cursor:pointer;
            font-family:inherit; font-size:0.8rem; transition:all 0.2s;
        }
        .filter-btn.active { background:var(--accent); color:#0a0a0a; border-color:var(--accent); font-weight:600; }

        /* Outfit summary */
        .outfit-bar {
            display:none; background:var(--bg2); border:1px solid var(--border);
            border-radius:var(--radius); padding:0.8rem 1rem; margin-bottom:1rem;
            font-size:0.85rem; color:var(--text2);
        }
        .outfit-bar.visible { display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; }
        .outfit-tag {
            background:var(--accent-soft); border:1px solid var(--accent);
            padding:3px 10px; border-radius:20px; font-size:0.8rem; color:var(--accent);
        }

        /* Buttons */
        .btn {
            padding:14px 24px; border-radius:var(--radius); border:none; cursor:pointer;
            font-family:inherit; font-size:0.95rem; font-weight:600; transition:all 0.2s;
        }
        .btn:active { transform:scale(0.97); }
        .btn-primary { background:var(--accent); color:#0a0a0a; }
        .btn-secondary { background:transparent; border:1px solid var(--border); color:var(--text); }
        .btn-row { display:flex; gap:0.75rem; margin-top:1.5rem; }
        .btn-row .btn { flex:1; }

        /* Camera */
        .camera-fs {
            display:none; position:fixed; top:0; left:0; right:0; bottom:0;
            z-index:999; background:#000;
        }
        .camera-fs video { width:100%; height:100%; object-fit:cover; }
        .camera-fs .guide {
            position:absolute; top:3%; left:5%; right:5%; bottom:12%;
            border:2px dashed rgba(201,165,90,0.5); border-radius:12px; pointer-events:none;
        }
        .camera-fs .guide-text {
            position:absolute; top:0.5%; left:0; right:0; text-align:center;
            color:rgba(255,255,255,0.8); font-size:0.85rem; pointer-events:none;
            text-shadow:0 1px 4px rgba(0,0,0,0.8);
        }
        .camera-fs .cam-btns {
            position:absolute; bottom:0; left:0; right:0;
            padding:1.5rem 1rem 2.5rem;
            background:linear-gradient(transparent, rgba(0,0,0,0.85));
            display:flex; justify-content:space-around; align-items:center;
        }
        .cam-btn {
            background:rgba(255,255,255,0.15); border:2px solid rgba(255,255,255,0.3);
            color:#fff; padding:14px 20px; border-radius:50px; cursor:pointer;
            font-family:inherit; font-size:1rem; font-weight:600; min-width:80px; text-align:center;
        }
        .cam-btn-main {
            background:var(--accent); border:3px solid #fff; color:#0a0a0a;
            padding:20px 30px; font-size:1.2rem; font-weight:700; min-width:120px;
            box-shadow:0 4px 15px rgba(0,0,0,0.4);
        }

        /* Photo preview */
        .preview { display:none; text-align:center; }
        .preview img { max-width:100%; max-height:45vh; border-radius:var(--radius); }

        /* Result */
        .result { display:none; text-align:center; }
        .result img { max-width:100%; border-radius:var(--radius); margin-bottom:1rem; }

        /* Loader */
        .loader { display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(10,10,10,0.92); z-index:500; justify-content:center; align-items:center; flex-direction:column; gap:1rem; }
        .loader.visible { display:flex; }
        .spinner { width:50px;height:50px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }
        .progress { width:250px;height:4px;background:var(--border);border-radius:4px;overflow:hidden; }
        .progress-bar { height:100%;background:var(--accent);width:0%;transition:width 0.5s; }

        /* Toast */
        .toast {
            position:fixed; bottom:2rem; left:50%; transform:translateX(-50%) translateY(100px);
            background:var(--card); border:1px solid var(--border); border-radius:8px;
            padding:0.8rem 1.5rem; color:var(--text); font-size:0.85rem; z-index:2000;
            opacity:0; transition:all 0.4s;
        }
        .toast.visible { transform:translateX(-50%) translateY(0); opacity:1; }
        .toast.success { border-color:var(--success); }
        .toast.error { border-color:var(--danger); }

        .share-btns { display:flex; gap:0.75rem; margin-top:1rem; }
        .btn-whatsapp { background:#25D366; border:none; color:#fff; font-weight:600; }
    </style>
</head>
<body>

<div class="header">
    <h1>‚ú® Probador Virtual</h1>
</div>

<div class="container">
    <div class="steps">
        <div class="step active" id="dot-1"></div>
        <div class="step" id="dot-2"></div>
        <div class="step" id="dot-3"></div>
        <div class="step" id="dot-4"></div>
    </div>

    <!-- STEP 1: PROFILE -->
    <div class="section active" id="step-1">
        <div class="section-title">¬øQui√©n eres?</div>
        <div class="section-sub">Selecciona tu g√©nero y medidas para recomendarte la talla</div>

        <div class="card">
            <div class="gender-opts">
                <button class="gender-opt" onclick="selectGender('mujer')">
                    <div class="icon">üë©</div><div class="label">Mujer</div>
                </button>
                <button class="gender-opt" onclick="selectGender('hombre')">
                    <div class="icon">üë®</div><div class="label">Hombre</div>
                </button>
            </div>
            <div class="form-row">
                <div class="field">
                    <label>Estatura (cm)</label>
                    <input type="number" id="height" placeholder="165" min="100" max="220">
                </div>
                <div class="field">
                    <label>Peso (kg)</label>
                    <input type="number" id="weight" placeholder="65" min="30" max="200">
                </div>
            </div>
            <div class="size-result" id="size-result">
                <div style="font-size:0.8rem; color:var(--text2);">Tu talla recomendada</div>
                <div class="size-big" id="size-display">M</div>
            </div>
        </div>

        <div class="btn-row">
            <button class="btn btn-primary" onclick="calcSize()" style="width:100%;">Continuar ‚Üí</button>
        </div>
    </div>

    <!-- STEP 2: GARMENTS -->
    <div class="section" id="step-2">
        <div class="section-title">Escoge tu ropa</div>
        <div class="section-sub">Selecciona una prenda superior, inferior, o un vestido</div>

        <div class="filters" id="filters">
            <button class="filter-btn active" onclick="filter('all')">Todas</button>
            <button class="filter-btn" onclick="filter('tops')">Tops</button>
            <button class="filter-btn" onclick="filter('bottoms')">Bottoms</button>
            <button class="filter-btn" onclick="filter('one-pieces')">Vestidos</button>
        </div>

        <div class="outfit-bar" id="outfit-bar">
            <span>Tu outfit:</span>
            <span id="outfit-tags"></span>
        </div>

        <div class="garments" id="garments-grid"></div>

        <div class="btn-row">
            <button class="btn btn-secondary" onclick="goStep(1)">‚Üê Atr√°s</button>
            <button class="btn btn-primary" id="btn-step3" disabled onclick="goStep(3)">Continuar ‚Üí</button>
        </div>
    </div>

    <!-- STEP 3: PHOTO -->
    <div class="section" id="step-3">
        <div class="section-title">Tu foto</div>
        <div class="section-sub">Foto de cuerpo completo para la prueba virtual</div>

        <div class="card" id="photo-guide">
            <div class="card-title">üìã Tips para la mejor foto</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; font-size:0.8rem;">
                <div style="color:var(--success);">
                    ‚úÖ Cuerpo completo<br>‚úÖ De frente<br>‚úÖ Buena luz<br>‚úÖ Fondo limpio
                </div>
                <div style="color:var(--danger);">
                    ‚ùå Foto cortada<br>‚ùå De lado<br>‚ùå Muy oscura<br>‚ùå Fondo desordenado
                </div>
            </div>
        </div>

        <div id="capture-btns" style="display:flex; gap:0.75rem;">
            <button class="btn btn-primary" onclick="openCam()" style="flex:1;padding:1rem;">üì∑ C√°mara</button>
            <button class="btn btn-secondary" onclick="document.getElementById('gal-input').click()" style="flex:1;padding:1rem;">üñºÔ∏è Galer√≠a</button>
        </div>
        <input type="file" id="gal-input" accept="image/*" onchange="galPhoto(this)" style="display:none">

        <div class="preview" id="photo-preview">
            <img id="preview-img" alt="Tu foto">
            <div class="btn-row" style="margin-top:0.75rem;">
                <button class="btn btn-secondary" onclick="retake()">üîÑ Cambiar</button>
                <button class="btn btn-primary" id="btn-gen" onclick="generate()">‚ú® Generar</button>
            </div>
        </div>

        <div class="btn-row" id="photo-nav">
            <button class="btn btn-secondary" onclick="goStep(2)">‚Üê Atr√°s</button>
        </div>
    </div>

    <!-- STEP 4: RESULT -->
    <div class="section" id="step-4">
        <div class="section-title">¬°As√≠ te queda!</div>
        <div class="section-sub" id="result-garments"></div>

        <div class="result" id="result-area">
            <img id="result-img" alt="Resultado">
            <div class="share-btns">
                <button class="btn btn-whatsapp" onclick="shareWA()" style="flex:1;">üí¨ Compartir</button>
                <button class="btn btn-secondary" onclick="goStep(3)" style="flex:1;">üîÑ Otra foto</button>
            </div>
            <button class="btn btn-secondary" onclick="goStep(2)" style="width:100%; margin-top:0.75rem;">üëó Probar otra ropa</button>
        </div>
    </div>
</div>

<!-- CAMERA FULLSCREEN -->
<div class="camera-fs" id="camera-view">
    <video id="cam-video" autoplay playsinline muted></video>
    <div class="guide"></div>
    <div class="guide-text">Ubica tu cuerpo completo</div>
    <div class="cam-btns">
        <button class="cam-btn" onclick="flipCam()">üîÑ<br><span style="font-size:0.75rem;">Voltear</span></button>
        <button class="cam-btn cam-btn-main" onclick="snapPhoto()">üì∏ Capturar</button>
        <button class="cam-btn" onclick="closeCam()">‚úï<br><span style="font-size:0.75rem;">Cerrar</span></button>
    </div>
</div>
<canvas id="cam-canvas" style="display:none;"></canvas>

<!-- LOADER -->
<div class="loader" id="loader">
    <div class="spinner"></div>
    <div id="loader-text" style="color:var(--text2);">Generando tu prueba virtual...</div>
    <div class="progress"><div class="progress-bar" id="prog-bar"></div></div>
    <div id="loader-step" style="font-size:0.75rem;color:var(--text2);margin-top:8px;"></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
    // State
    let profile = { gender:null, size:'M' };
    let outfit = { top:null, bottom:null, onepiece:null };
    let catalog = [];
    let photoFile = null;
    let camStream = null;
    let frontCam = false;

    // Navigation
    function goStep(n) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(`step-${n}`).classList.add('active');
        document.querySelectorAll('.step').forEach((d,i) => {
            d.className = 'step';
            if (i+1 === n) d.classList.add('active');
            else if (i+1 < n) d.classList.add('done');
        });
        if (n === 2) loadCatalog();
        if (n === 4) document.getElementById('result-area').style.display = 'block';
    }

    // Step 1
    function selectGender(g) {
        profile.gender = g;
        document.querySelectorAll('.gender-opt').forEach(b => b.classList.remove('selected'));
        event.currentTarget.classList.add('selected');
    }

    async function calcSize() {
        if (!profile.gender) { toast('Selecciona tu g√©nero','error'); return; }
        const h = parseFloat(document.getElementById('height').value);
        const w = parseFloat(document.getElementById('weight').value);
        if (!h || !w) { toast('Ingresa estatura y peso','error'); return; }

        const form = new FormData();
        form.append('gender', profile.gender);
        form.append('height_cm', h);
        form.append('weight_kg', w);

        try {
            const r = await fetch('/api/estimate-size', {method:'POST', body:form});
            const d = await r.json();
            profile.size = d.estimated_size;
            document.getElementById('size-display').textContent = d.estimated_size;
            document.getElementById('size-result').classList.add('visible');
            toast(`Talla: ${d.estimated_size}`, 'success');
            setTimeout(() => goStep(2), 600);
        } catch(e) { toast('Error calculando talla','error'); }
    }

    // Step 2
    async function loadCatalog() {
        try {
            const g = profile.gender || '';
            const r = await fetch(`/api/catalog?gender=${g}`);
            catalog = await r.json();
            renderGarments(catalog);
        } catch(e) {}
    }

    function renderGarments(items) {
        const grid = document.getElementById('garments-grid');
        if (!items.length) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--text2);">No hay prendas disponibles</div>';
            return;
        }
        grid.innerHTML = items.map(g => {
            const sel = g.id===outfit.top || g.id===outfit.bottom || g.id===outfit.onepiece;
            const icon = g.category==='tops'?'üëï':g.category==='bottoms'?'üëñ':'üëó';
            return `
            <div class="garment ${sel?'selected':''}" onclick="toggle('${g.id}')">
                <div class="check">‚úì</div>
                <img src="${g.image_url}" alt="${g.name}">
                <div class="info">
                    <div class="name">${g.name}</div>
                    <div class="meta">${icon} ${g.size}</div>
                    ${g.price ? `<div class="price">$${Number(g.price).toLocaleString('es-CO')}</div>` : ''}
                </div>
            </div>`;
        }).join('');
    }

    function toggle(id) {
        const g = catalog.find(x => x.id===id);
        if (!g) return;
        if (g.category === 'one-pieces') {
            outfit.onepiece = outfit.onepiece===id ? null : id;
            if (outfit.onepiece) { outfit.top=null; outfit.bottom=null; }
        } else if (g.category === 'tops') {
            outfit.top = outfit.top===id ? null : id;
            if (outfit.top) outfit.onepiece=null;
        } else {
            outfit.bottom = outfit.bottom===id ? null : id;
            if (outfit.bottom) outfit.onepiece=null;
        }
        renderGarments(catalog.filter(x => document.querySelector('.filter-btn.active')?.textContent==='Todas' || x.category===document.querySelector('.filter-btn.active')?.dataset?.cat || true));
        updateOutfit();
    }

    function updateOutfit() {
        const has = outfit.top||outfit.bottom||outfit.onepiece;
        document.getElementById('btn-step3').disabled = !has;
        const bar = document.getElementById('outfit-bar');
        if (has) {
            bar.classList.add('visible');
            let tags = '';
            if (outfit.top) tags += `<span class="outfit-tag">üëï ${catalog.find(x=>x.id===outfit.top)?.name}</span> `;
            if (outfit.bottom) tags += `<span class="outfit-tag">üëñ ${catalog.find(x=>x.id===outfit.bottom)?.name}</span> `;
            if (outfit.onepiece) tags += `<span class="outfit-tag">üëó ${catalog.find(x=>x.id===outfit.onepiece)?.name}</span>`;
            document.getElementById('outfit-tags').innerHTML = tags;
        } else { bar.classList.remove('visible'); }
        renderGarments(catalog);
    }

    function filter(cat) {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        event.currentTarget.classList.add('active');
        if (cat==='all') renderGarments(catalog);
        else renderGarments(catalog.filter(g => g.category===cat));
    }

    // Step 3: Camera
    async function openCam() {
        try {
            camStream = await navigator.mediaDevices.getUserMedia({
                video:{facingMode:frontCam?'user':'environment',width:{ideal:1280},height:{ideal:1920}}, audio:false
            });
            document.getElementById('cam-video').srcObject = camStream;
            document.getElementById('camera-view').style.display = 'block';
        } catch(e) { toast('No se pudo abrir la c√°mara','error'); }
    }

    function flipCam() { frontCam=!frontCam; closeCam(); openCam(); }

    function closeCam() {
        if(camStream) camStream.getTracks().forEach(t=>t.stop());
        camStream=null;
        document.getElementById('cam-video').srcObject=null;
        document.getElementById('camera-view').style.display='none';
    }

    function snapPhoto() {
        const v = document.getElementById('cam-video');
        const c = document.getElementById('cam-canvas');
        if (!v.videoWidth) return;
        let w=v.videoWidth, h=v.videoHeight;
        if(w>1200||h>1200){if(w>h){h=Math.round(h*1200/w);w=1200;}else{w=Math.round(w*1200/h);h=1200;}}
        c.width=w; c.height=h;
        c.getContext('2d').drawImage(v,0,0,w,h);
        closeCam();

        const dataUrl = c.toDataURL('image/jpeg', 0.85);
        const byteStr = atob(dataUrl.split(',')[1]);
        const ab = new ArrayBuffer(byteStr.length);
        const ia = new Uint8Array(ab);
        for(let i=0;i<byteStr.length;i++) ia[i]=byteStr.charCodeAt(i);
        photoFile = new File([new Blob([ab],{type:'image/jpeg'})], 'camera.jpg', {type:'image/jpeg',lastModified:Date.now()});
        showPreview(dataUrl);
    }

    function galPhoto(input) {
        if(!input.files||!input.files[0]) return;
        const file = input.files[0];
        const img = new Image();
        img.onload = () => {
            let w=img.width,h=img.height;
            if(w>1200||h>1200){if(w>h){h=Math.round(h*1200/w);w=1200;}else{w=Math.round(w*1200/h);h=1200;}}
            const c=document.createElement('canvas');c.width=w;c.height=h;
            c.getContext('2d').drawImage(img,0,0,w,h);
            c.toBlob(b=>{
                photoFile=new File([b],'photo.jpg',{type:'image/jpeg'});
                showPreview(URL.createObjectURL(b));
            },'image/jpeg',0.85);
        };
        img.src = URL.createObjectURL(file);
    }

    function showPreview(src) {
        document.getElementById('preview-img').src = src;
        document.getElementById('photo-preview').style.display = 'block';
        document.getElementById('capture-btns').style.display = 'none';
        document.getElementById('photo-guide').style.display = 'none';
        document.getElementById('photo-nav').style.display = 'none';
    }

    function retake() {
        photoFile=null;
        document.getElementById('photo-preview').style.display='none';
        document.getElementById('capture-btns').style.display='flex';
        document.getElementById('photo-guide').style.display='block';
        document.getElementById('photo-nav').style.display='flex';
        document.getElementById('result-area').style.display='none';
        document.getElementById('btn-gen').disabled=false;
        document.getElementById('btn-gen').textContent='‚ú® Generar';
    }

    // Step 4: Generate
    async function generate() {
        if(!photoFile) return;
        const btn = document.getElementById('btn-gen');
        btn.disabled=true; btn.textContent='‚è≥ Generando...';

        document.getElementById('loader').classList.add('visible');
        const bar = document.getElementById('prog-bar');
        let elapsed=0;
        const timer = setInterval(()=>{
            elapsed+=0.5;
            bar.style.width = Math.min(90,elapsed/10*100)+'%';
            const step = document.getElementById('loader-step');
            if(outfit.top && elapsed<5) step.textContent='üëï Probando superior...';
            else if(outfit.bottom && elapsed<8) step.textContent='üëñ Probando inferior...';
            else step.textContent='‚ú® Finalizando...';
        },500);

        const form = new FormData();
        form.append('model_image', photoFile);
        if(outfit.top) form.append('top_id', outfit.top);
        if(outfit.bottom) form.append('bottom_id', outfit.bottom);
        if(outfit.onepiece) form.append('onepiece_id', outfit.onepiece);

        try {
            const controller = new AbortController();
            setTimeout(()=>controller.abort(), 180000);
            const resp = await fetch('/api/try-on-outfit', {method:'POST',body:form,signal:controller.signal});
            clearInterval(timer); bar.style.width='100%';

            if(!resp.ok) {
                const err = await resp.text();
                document.getElementById('loader').classList.remove('visible');
                btn.disabled=false; btn.textContent='‚ú® Generar';
                toast('Error: '+err.substring(0,100),'error');
                return;
            }

            const data = await resp.json();
            document.getElementById('loader').classList.remove('visible');

            if(data.success) {
                document.getElementById('result-img').src = data.result_image;
                const names = data.garments_used.map(g=>g.name).join(' + ');
                document.getElementById('result-garments').textContent = names;
                goStep(4);
            } else {
                btn.disabled=false; btn.textContent='‚ú® Generar';
                toast('Error generando','error');
            }
        } catch(e) {
            clearInterval(timer);
            document.getElementById('loader').classList.remove('visible');
            btn.disabled=false; btn.textContent='‚ú® Generar';
            toast('Error: '+e.message,'error');
        }
    }

    function shareWA() {
        const text = encodeURIComponent('¬°Mira c√≥mo me queda esta ropa! üëó‚ú®\n' + window.location.href);
        window.open('https://wa.me/?text='+text, '_blank');
    }

    function toast(msg, type='') {
        const t = document.getElementById('toast');
        t.textContent=msg; t.className=`toast visible ${type}`;
        setTimeout(()=>t.classList.remove('visible'),3000);
    }
</script>
</body>
</html>
