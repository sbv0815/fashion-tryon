<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Probador Virtual</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#c9a55a">
    <meta name="mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a; --bg2: #141414; --card: #1a1a1a;
            --border: #2a2520; --border-light: #3a3530;
            --accent: #c9a55a; --accent-soft: rgba(201,165,90,0.15);
            --text: #f0ece4; --text2: #8a8578; --text3: #5a554e;
            --success: #4ade80; --danger: #ef4444;
            --radius: 12px;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

        .header {
            background:var(--bg2); border-bottom:1px solid var(--border);
            padding:0.8rem 1.2rem; display:flex; align-items:center; justify-content:center;
            position:sticky; top:0; z-index:100;
        }
        .header h1 {
            font-family:'Playfair Display',serif; font-size:1.2rem; font-weight:600;
            background:linear-gradient(135deg, var(--accent), #e8d5a3);
            -webkit-background-clip:text; -webkit-text-fill-color:transparent;
            background-clip:text;
        }

        .container { max-width:600px; margin:0 auto; padding:1rem; }

        .steps { display:flex; justify-content:center; gap:0.3rem; margin:1rem 0 1.5rem; }
        .step { width:10px; height:10px; border-radius:50%; background:var(--border); transition:all 0.3s; }
        .step.active { background:var(--accent); width:28px; border-radius:5px; }
        .step.done { background:var(--success); }

        .section { display:none; }
        .section.active { display:block; animation:fadeIn 0.3s; }
        @keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

        .section-title { font-family:'Playfair Display',serif; font-size:1.4rem; font-weight:700; margin-bottom:0.3rem; }
        .section-sub { color:var(--text2); font-size:0.85rem; margin-bottom:1.2rem; }

        .card { background:var(--bg2); border:1px solid var(--border); border-radius:var(--radius); padding:1.2rem; margin-bottom:1rem; }
        .card-title { font-weight:600; margin-bottom:0.8rem; font-size:0.95rem; }

        .gender-opts { display:flex; gap:0.75rem; }
        .gender-opt {
            flex:1; padding:1.2rem; text-align:center; border-radius:var(--radius);
            border:2px solid var(--border); background:var(--bg); cursor:pointer;
            transition:all 0.3s; font-family:inherit; color:var(--text);
        }
        .gender-opt.selected { border-color:var(--accent); background:var(--accent-soft); }
        .gender-opt .icon { font-size:2rem; margin-bottom:0.3rem; }
        .gender-opt .label { font-size:0.85rem; font-weight:500; }

        .form-row { display:flex; gap:0.75rem; margin-top:1rem; }
        .form-row .field { flex:1; }
        .form-row label { display:block; font-size:0.8rem; color:var(--text2); margin-bottom:4px; }
        .form-row input, .form-row select {
            width:100%; padding:10px 12px; background:var(--bg); border:1px solid var(--border);
            border-radius:8px; color:var(--text); font-family:inherit; font-size:0.95rem;
        }

        .size-result { display:none; text-align:center; margin-top:1rem; padding:1rem; background:var(--accent-soft); border-radius:var(--radius); }
        .size-result.visible { display:block; }
        .size-big { font-size:2.5rem; font-weight:700; color:var(--accent); }

        /* Garments grid */
        .garments { display:grid; grid-template-columns:repeat(2,1fr); gap:0.75rem; }
        .garment {
            background:var(--card); border:2px solid var(--border); border-radius:var(--radius);
            overflow:hidden; cursor:pointer; transition:all 0.3s; position:relative;
        }
        .garment.selected { border-color:var(--accent); box-shadow:0 0 0 1px var(--accent); }
        .garment.disabled { cursor:default; opacity:0.5; }
        .garment img { width:100%; height:160px; object-fit:cover; background:#111; }
        .garment .info { padding:0.6rem 0.8rem; }
        .garment .name { font-weight:600; font-size:0.85rem; }
        .garment .meta { font-size:0.75rem; color:var(--text2); margin-top:2px; }
        .garment .price { color:var(--accent); font-weight:600; font-size:0.85rem; margin-top:2px; }
        .garment .check {
            position:absolute; top:8px; right:8px; width:24px; height:24px;
            background:var(--accent); border-radius:50%; display:none;
            align-items:center; justify-content:center; color:#0a0a0a; font-size:0.8rem; font-weight:700;
        }
        .garment.selected .check { display:flex; }
        .garment .tryon-badge {
            position:absolute; top:8px; left:8px;
            background:var(--accent); color:#0a0a0a; padding:2px 8px; border-radius:10px;
            font-size:0.65rem; font-weight:700;
        }
        .garment .no-tryon-badge {
            position:absolute; top:8px; left:8px;
            background:rgba(0,0,0,0.7); color:var(--text2); padding:2px 8px; border-radius:10px;
            font-size:0.65rem; font-weight:500;
        }

        .filters { display:flex; gap:0.5rem; margin-bottom:1rem; flex-wrap:wrap; }
        .filter-btn {
            padding:6px 14px; border-radius:20px; border:1px solid var(--border);
            background:transparent; color:var(--text2); cursor:pointer;
            font-family:inherit; font-size:0.8rem; transition:all 0.2s;
        }
        .filter-btn.active { background:var(--accent); color:#0a0a0a; border-color:var(--accent); font-weight:600; }

        .outfit-bar {
            display:none; background:var(--bg2); border:1px solid var(--border);
            border-radius:var(--radius); padding:0.8rem 1rem; margin-bottom:1rem;
            font-size:0.85rem; color:var(--text2);
        }
        .outfit-bar.visible { display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; }
        .outfit-tag {
            background:var(--accent-soft); border:1px solid var(--accent);
            padding:3px 10px; border-radius:20px; font-size:0.8rem; color:var(--accent);
        }

        .btn {
            padding:14px 24px; border-radius:var(--radius); border:none; cursor:pointer;
            font-family:inherit; font-size:0.95rem; font-weight:600; transition:all 0.2s;
        }
        .btn:active { transform:scale(0.97); }
        .btn-primary { background:var(--accent); color:#0a0a0a; }
        .btn-secondary { background:transparent; border:1px solid var(--border); color:var(--text); }
        .btn-row { display:flex; gap:0.75rem; margin-top:1.5rem; }
        .btn-row .btn { flex:1; }

        /* Camera */
        .camera-fs {
            display:none; position:fixed; top:0; left:0; right:0; bottom:0;
            z-index:999; background:#000;
        }
        .camera-fs video { width:100%; height:100%; object-fit:cover; }
        .camera-fs .guide {
            position:absolute; top:3%; left:5%; right:5%; bottom:12%;
            border:2px dashed rgba(201,165,90,0.5); border-radius:12px; pointer-events:none;
        }
        .camera-fs .guide-text {
            position:absolute; top:0.5%; left:0; right:0; text-align:center;
            color:rgba(255,255,255,0.8); font-size:0.85rem; pointer-events:none;
            text-shadow:0 1px 4px rgba(0,0,0,0.8);
        }
        .camera-fs .cam-btns {
            position:absolute; bottom:0; left:0; right:0;
            padding:1.5rem 1rem 2.5rem;
            background:linear-gradient(transparent, rgba(0,0,0,0.85));
            display:flex; justify-content:space-around; align-items:center;
        }
        .cam-btn {
            background:rgba(255,255,255,0.15); border:2px solid rgba(255,255,255,0.3);
            color:#fff; padding:14px 20px; border-radius:50px; cursor:pointer;
            font-family:inherit; font-size:1rem; font-weight:600; min-width:80px; text-align:center;
        }
        .cam-btn-main {
            background:var(--accent); border:3px solid #fff; color:#0a0a0a;
            padding:20px 30px; font-size:1.2rem; font-weight:700; min-width:120px;
            box-shadow:0 4px 15px rgba(0,0,0,0.4);
        }

        .preview { display:none; text-align:center; }
        .preview img { max-width:100%; max-height:45vh; border-radius:var(--radius); }

        .result { display:none; text-align:center; }
        .result img { max-width:100%; border-radius:var(--radius); margin-bottom:1rem; }

        .loader { display:none; position:fixed; top:0;left:0;right:0;bottom:0; background:rgba(10,10,10,0.92); z-index:500; justify-content:center; align-items:center; flex-direction:column; gap:1rem; }
        .loader.visible { display:flex; }
        .spinner { width:50px;height:50px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite; }
        @keyframes spin { to{transform:rotate(360deg)} }
        .progress { width:250px;height:4px;background:var(--border);border-radius:4px;overflow:hidden; }
        .progress-bar { height:100%;background:var(--accent);width:0%;transition:width 0.5s; }

        .toast {
            position:fixed; bottom:2rem; left:50%; transform:translateX(-50%) translateY(100px);
            background:var(--card); border:1px solid var(--border); border-radius:8px;
            padding:0.8rem 1.5rem; color:var(--text); font-size:0.85rem; z-index:2000;
            opacity:0; transition:all 0.4s;
        }
        .toast.visible { transform:translateX(-50%) translateY(0); opacity:1; }
        .toast.success { border-color:var(--success); }
        .toast.error { border-color:var(--danger); }

        /* Share section */
        .share-section { margin-top:1.2rem; }
        .share-title-sm { font-size:0.8rem; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-bottom:0.6rem; text-align:center; }
        .share-grid { display:grid; grid-template-columns:repeat(2,1fr); gap:0.5rem; }
        .share-btn {
            display:flex; align-items:center; justify-content:center; gap:6px;
            padding:11px; border-radius:10px; border:none; cursor:pointer;
            font-family:'DM Sans',sans-serif; font-size:0.8rem; font-weight:600; transition:all 0.2s;
        }
        .share-btn:active { transform:scale(0.96); }
        .share-whatsapp { background:#25D366; color:#fff; }
        .share-instagram { background:linear-gradient(135deg,#833ab4,#fd1d1d,#fcb045); color:#fff; }
        .share-facebook { background:#1877F2; color:#fff; }
        .share-copy { background:var(--card); border:1px solid var(--border); color:var(--text); }
        .share-download { background:var(--accent); color:#0a0a0a; grid-column:1/-1; }
    </style>
</head>
<body>

<div class="header">
    <h1 id="header-title">‚ú® Probador Virtual</h1>
</div>

<div class="container">
    <div class="steps">
        <div class="step active" id="dot-1"></div>
        <div class="step" id="dot-2"></div>
        <div class="step" id="dot-3"></div>
        <div class="step" id="dot-4"></div>
    </div>

    <!-- STEP 1: PROFILE -->
    <div class="section active" id="step-1">
        <div class="section-title">¬øQui√©n eres?</div>
        <div class="section-sub">Selecciona tu g√©nero y medidas para recomendarte la talla</div>
        <div class="card">
            <div class="gender-opts">
                <button class="gender-opt" onclick="selectGender('mujer')">
                    <div class="icon">üë©</div><div class="label">Mujer</div>
                </button>
                <button class="gender-opt" onclick="selectGender('hombre')">
                    <div class="icon">üë®</div><div class="label">Hombre</div>
                </button>
            </div>
            <div class="form-row">
                <div class="field"><label>Estatura (cm)</label><input type="number" id="height" placeholder="165" min="100" max="220"></div>
                <div class="field"><label>Peso (kg)</label><input type="number" id="weight" placeholder="65" min="30" max="200"></div>
            </div>
            <div class="size-result" id="size-result">
                <div style="font-size:0.8rem; color:var(--text2);">Tu talla recomendada</div>
                <div class="size-big" id="size-display">M</div>
            </div>
        </div>
        <div class="btn-row">
            <button class="btn btn-primary" onclick="calcSize()" style="width:100%;">Continuar ‚Üí</button>
        </div>
    </div>

    <!-- STEP 2: GARMENTS -->
    <div class="section" id="step-2">
        <div class="section-title">Escoge tu ropa</div>
        <div class="section-sub" id="step2-sub">Selecciona las prendas marcadas con ‚ú®</div>

        <div class="filters" id="filters">
            <button class="filter-btn active" onclick="filterCat('all')">Todas</button>
            <button class="filter-btn" onclick="filterCat('tops')">üëï Tops</button>
            <button class="filter-btn" onclick="filterCat('bottoms')">üëñ Bottoms</button>
            <button class="filter-btn" onclick="filterCat('one-pieces')">üëó Vestidos</button>
        </div>

        <div class="outfit-bar" id="outfit-bar">
            <span>Tu outfit:</span>
            <span id="outfit-tags"></span>
        </div>

        <div class="garments" id="garments-grid"></div>

        <div class="btn-row">
            <button class="btn btn-secondary" onclick="goStep(1)">‚Üê Atr√°s</button>
            <button class="btn btn-primary" id="btn-step3" disabled onclick="goStep(3)">Continuar ‚Üí</button>
        </div>
    </div>

    <!-- STEP 3: PHOTO -->
    <div class="section" id="step-3">
        <div class="section-title">Tu foto</div>
        <div class="section-sub">Foto de cuerpo completo para la prueba virtual</div>
        <div class="card" id="photo-guide">
            <div class="card-title">üìã Tips para la mejor foto</div>
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:0.75rem; font-size:0.8rem;">
                <div style="color:var(--success);">‚úÖ Cuerpo completo<br>‚úÖ De frente<br>‚úÖ Buena luz<br>‚úÖ Fondo limpio</div>
                <div style="color:var(--danger);">‚ùå Foto cortada<br>‚ùå De lado<br>‚ùå Muy oscura<br>‚ùå Fondo desordenado</div>
            </div>
        </div>
        <div id="capture-btns" style="display:flex; gap:0.75rem;">
            <button class="btn btn-primary" onclick="openCam()" style="flex:1;padding:1rem;">üì∑ C√°mara</button>
            <button class="btn btn-secondary" onclick="document.getElementById('gal-input').click()" style="flex:1;padding:1rem;">üñºÔ∏è Galer√≠a</button>
        </div>
        <input type="file" id="gal-input" accept="image/*" onchange="galPhoto(this)" style="display:none">
        <div class="preview" id="photo-preview">
            <img id="preview-img" alt="Tu foto">
            <div class="btn-row" style="margin-top:0.75rem;">
                <button class="btn btn-secondary" onclick="retake()">üîÑ Cambiar</button>
                <button class="btn btn-primary" id="btn-gen" onclick="generate()">‚ú® Generar</button>
            </div>
        </div>
        <div class="btn-row" id="photo-nav">
            <button class="btn btn-secondary" onclick="goStep(2)">‚Üê Atr√°s</button>
        </div>
    </div>

    <!-- STEP 4: RESULT -->
    <div class="section" id="step-4">
        <div class="section-title">¬°As√≠ te queda!</div>
        <div class="section-sub" id="result-garments"></div>
        <div class="result" id="result-area">
            <img id="result-img" alt="Resultado">

            <!-- Share section -->
            <div class="share-section">
                <div class="share-title-sm">‚ú® Comparte tu look</div>
                <div class="share-grid">
                    <button class="share-btn share-whatsapp" onclick="shareWhatsApp()">üí¨ WhatsApp</button>
                    <button class="share-btn share-instagram" onclick="shareInstagram()">üì∏ Instagram</button>
                    <button class="share-btn share-facebook" onclick="shareFacebook()">üë§ Facebook</button>
                    <button class="share-btn share-copy" onclick="copyShareLink()">üîó Copiar link</button>
                    <a class="share-btn share-download" id="downloadBtn" href="#" download="mi_look.jpg">‚¨áÔ∏è Descargar imagen branded</a>
                </div>
            </div>

            <!-- Buy button -->
            <div id="buy-section" style="margin-top:1.2rem;">
                <button class="btn btn-primary" onclick="buyWhatsApp()" style="width:100%;padding:16px;font-size:1.05rem;background:#25D366;border-radius:14px;">
                    üõí ¬°Lo quiero! Comprar por WhatsApp
                </button>
            </div>

            <!-- Feedback section -->
            <div id="feedback-section" style="margin-top:1.2rem;">
                <div class="card" style="border-color:var(--accent);">
                    <div class="card-title" style="text-align:center;">‚≠ê ¬øQu√© te pareci√≥?</div>
                    <div style="font-size:0.75rem;color:var(--text3);text-align:center;margin-bottom:0.8rem;">Tu opini√≥n es privada y ayuda a mejorar la colecci√≥n</div>

                    <!-- Star rating -->
                    <div id="stars" style="display:flex;justify-content:center;gap:8px;margin-bottom:1rem;">
                        <span class="star" onclick="setRating(1)" style="font-size:2rem;cursor:pointer;opacity:0.3;">‚≠ê</span>
                        <span class="star" onclick="setRating(2)" style="font-size:2rem;cursor:pointer;opacity:0.3;">‚≠ê</span>
                        <span class="star" onclick="setRating(3)" style="font-size:2rem;cursor:pointer;opacity:0.3;">‚≠ê</span>
                        <span class="star" onclick="setRating(4)" style="font-size:2rem;cursor:pointer;opacity:0.3;">‚≠ê</span>
                        <span class="star" onclick="setRating(5)" style="font-size:2rem;cursor:pointer;opacity:0.3;">‚≠ê</span>
                    </div>

                    <!-- Comment -->
                    <textarea id="feedback-comment" placeholder="¬øAlg√∫n comentario sobre la prenda? (opcional)"
                        style="width:100%;padding:10px 12px;background:var(--bg);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:inherit;font-size:0.85rem;resize:vertical;min-height:60px;"></textarea>

                    <button class="btn btn-primary" onclick="submitFeedback()" id="btn-feedback"
                        style="width:100%;margin-top:0.8rem;padding:12px;">
                        Enviar opini√≥n
                    </button>
                </div>
            </div>

            <!-- Thank you (shown after feedback) -->
            <div id="feedback-thanks" style="display:none;margin-top:1.2rem;">
                <div class="card" style="border-color:var(--success);text-align:center;padding:1.5rem;">
                    <div style="font-size:2rem;margin-bottom:0.5rem;">üôè</div>
                    <div style="font-weight:600;color:var(--success);">¬°Gracias por tu opini√≥n!</div>
                    <div style="font-size:0.8rem;color:var(--text2);margin-top:4px;">Tu feedback ayuda a mejorar la colecci√≥n</div>
                </div>
            </div>

            <div class="btn-row" style="margin-top:1rem;">
                <button class="btn btn-secondary" onclick="goStep(3)">üîÑ Otra foto</button>
                <button class="btn btn-secondary" onclick="goStep(2)">üëó Otra ropa</button>
            </div>
        </div>
    </div>
</div>

<!-- CAMERA FULLSCREEN -->
<div class="camera-fs" id="camera-view">
    <video id="cam-video" autoplay playsinline muted></video>
    <div class="guide"></div>
    <div class="guide-text">Ubica tu cuerpo completo</div>
    <div class="cam-btns">
        <button class="cam-btn" onclick="flipCam()">üîÑ<br><span style="font-size:0.75rem;">Voltear</span></button>
        <button class="cam-btn cam-btn-main" onclick="snapPhoto()">üì∏ Capturar</button>
        <button class="cam-btn" onclick="closeCam()">‚úï<br><span style="font-size:0.75rem;">Cerrar</span></button>
    </div>
</div>
<canvas id="cam-canvas" style="display:none;"></canvas>

<!-- LOADER -->
<div class="loader" id="loader">
    <div class="spinner"></div>
    <div id="loader-text" style="color:var(--text2);">Generando tu prueba virtual...</div>
    <div class="progress"><div class="progress-bar" id="prog-bar"></div></div>
    <div id="loader-step" style="font-size:0.75rem;color:var(--text2);margin-top:8px;"></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
// ============================================================
// STATE
// ============================================================
const STORE_ID = new URLSearchParams(window.location.search).get('store') || '';
let profile = { gender:null, size:'M' };
let outfit = { top:null, bottom:null, onepiece:null };
let catalog = [];
let photoFile = null;
let camStream = null;
let frontCam = false;
let storeName = '';
let lastResultId = null;
let lastShareUrl = null;
let lastStoreData = null;

// Load store info
async function loadStoreInfo() {
    if (!STORE_ID) return;
    try {
        const r = await fetch(`/api/store-info/${STORE_ID}`);
        if (r.ok) {
            const d = await r.json();
            storeName = d.name;
            document.getElementById('header-title').textContent = d.name;
            document.title = d.name + ' - Probador Virtual';
        }
    } catch(e) {}
}
loadStoreInfo();

// ============================================================
// NAVIGATION
// ============================================================
function goStep(n) {
    document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
    document.getElementById(`step-${n}`).classList.add('active');
    document.querySelectorAll('.step').forEach((d,i) => {
        d.className = 'step';
        if (i+1 === n) d.classList.add('active');
        else if (i+1 < n) d.classList.add('done');
    });
    if (n === 2) loadCatalog();
    if (n === 4) document.getElementById('result-area').style.display = 'block';
}

// ============================================================
// STEP 1: PROFILE
// ============================================================
function selectGender(g) {
    profile.gender = g;
    document.querySelectorAll('.gender-opt').forEach(b => b.classList.remove('selected'));
    event.currentTarget.classList.add('selected');
}

async function calcSize() {
    if (!profile.gender) { toast('Selecciona tu g√©nero','error'); return; }
    const h = parseFloat(document.getElementById('height').value);
    const w = parseFloat(document.getElementById('weight').value);
    if (!h || !w) { toast('Ingresa estatura y peso','error'); return; }
    const form = new FormData();
    form.append('gender', profile.gender);
    form.append('height_cm', h);
    form.append('weight_kg', w);
    try {
        const r = await fetch('/api/estimate-size', {method:'POST', body:form});
        const d = await r.json();
        profile.size = d.estimated_size;
        document.getElementById('size-display').textContent = d.estimated_size;
        document.getElementById('size-result').classList.add('visible');
        toast(`Talla: ${d.estimated_size}`, 'success');
        setTimeout(() => goStep(2), 600);
    } catch(e) { toast('Error calculando talla','error'); }
}

// ============================================================
// STEP 2: GARMENTS
// ============================================================
let currentFilter = 'all';

async function loadCatalog() {
    try {
        const g = profile.gender || '';
        const storeParam = STORE_ID ? `&store_id=${STORE_ID}` : '';
        const r = await fetch(`/api/catalog?gender=${g}${storeParam}`);
        const data = await r.json();
        catalog = data.garments || data;
        if (data.store_name) {
            storeName = data.store_name;
            document.getElementById('header-title').textContent = data.store_name;
            document.getElementById('step2-sub').textContent = `Cat√°logo de ${data.store_name} ¬∑ Selecciona prendas con ‚ú®`;
        }
        renderGarments();
    } catch(e) { console.error(e); }
}

function renderGarments() {
    const items = currentFilter === 'all' ? catalog : catalog.filter(g => g.category === currentFilter);
    const grid = document.getElementById('garments-grid');
    if (!items.length) {
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:2rem;color:var(--text2);">No hay prendas disponibles</div>';
        return;
    }

    // Sort: tryon_enabled first
    const sorted = [...items].sort((a,b) => (b.tryon_enabled?1:0) - (a.tryon_enabled?1:0));

    grid.innerHTML = sorted.map(g => {
        const sel = g.id===outfit.top || g.id===outfit.bottom || g.id===outfit.onepiece;
        const icon = g.category==='tops'?'üëï':g.category==='bottoms'?'üëñ':'üëó';
        const canTry = g.tryon_enabled;
        return `
        <div class="garment ${sel?'selected':''} ${canTry?'':'disabled'}" onclick="${canTry ? `toggle('${g.id}')` : 'toast(\"Esta prenda a√∫n no tiene probador virtual\",\"error\")'}">
            ${canTry ? '<div class="check">‚úì</div>' : ''}
            ${canTry ? '<div class="tryon-badge">‚ú® Probador IA</div>' : '<div class="no-tryon-badge">Solo exhibici√≥n</div>'}
            <img src="${g.image_url}" alt="${g.name}">
            <div class="info">
                <div class="name">${g.name}</div>
                <div class="meta">${icon} ${g.size}</div>
                ${g.price ? `<div class="price">$${Number(g.price).toLocaleString('es-CO')}</div>` : ''}
            </div>
        </div>`;
    }).join('');
}

function toggle(id) {
    const g = catalog.find(x => x.id===id);
    if (!g || !g.tryon_enabled) return;
    if (g.category === 'one-pieces') {
        outfit.onepiece = outfit.onepiece===id ? null : id;
        if (outfit.onepiece) { outfit.top=null; outfit.bottom=null; }
    } else if (g.category === 'tops') {
        outfit.top = outfit.top===id ? null : id;
        if (outfit.top) outfit.onepiece=null;
    } else {
        outfit.bottom = outfit.bottom===id ? null : id;
        if (outfit.bottom) outfit.onepiece=null;
    }
    renderGarments();
    updateOutfit();
}

function updateOutfit() {
    const has = outfit.top||outfit.bottom||outfit.onepiece;
    document.getElementById('btn-step3').disabled = !has;
    const bar = document.getElementById('outfit-bar');
    if (has) {
        bar.classList.add('visible');
        let tags = '';
        if (outfit.top) tags += `<span class="outfit-tag">üëï ${catalog.find(x=>x.id===outfit.top)?.name}</span> `;
        if (outfit.bottom) tags += `<span class="outfit-tag">üëñ ${catalog.find(x=>x.id===outfit.bottom)?.name}</span> `;
        if (outfit.onepiece) tags += `<span class="outfit-tag">üëó ${catalog.find(x=>x.id===outfit.onepiece)?.name}</span>`;
        document.getElementById('outfit-tags').innerHTML = tags;
    } else { bar.classList.remove('visible'); }
}

function filterCat(cat) {
    currentFilter = cat;
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    event.currentTarget.classList.add('active');
    renderGarments();
}

// ============================================================
// STEP 3: CAMERA
// ============================================================
async function openCam() {
    try {
        camStream = await navigator.mediaDevices.getUserMedia({
            video:{facingMode:frontCam?'user':'environment',width:{ideal:1280},height:{ideal:1920}}, audio:false
        });
        document.getElementById('cam-video').srcObject = camStream;
        document.getElementById('camera-view').style.display = 'block';
    } catch(e) { toast('No se pudo abrir la c√°mara','error'); }
}

function flipCam() { frontCam=!frontCam; closeCam(); openCam(); }

function closeCam() {
    if(camStream) camStream.getTracks().forEach(t=>t.stop());
    camStream=null;
    document.getElementById('cam-video').srcObject=null;
    document.getElementById('camera-view').style.display='none';
}

function snapPhoto() {
    const v = document.getElementById('cam-video');
    const c = document.getElementById('cam-canvas');
    if (!v.videoWidth) return;
    let w=v.videoWidth, h=v.videoHeight;
    if(w>1200||h>1200){if(w>h){h=Math.round(h*1200/w);w=1200;}else{w=Math.round(w*1200/h);h=1200;}}
    c.width=w; c.height=h;
    c.getContext('2d').drawImage(v,0,0,w,h);
    closeCam();
    const dataUrl = c.toDataURL('image/jpeg', 0.85);
    const byteStr = atob(dataUrl.split(',')[1]);
    const ab = new ArrayBuffer(byteStr.length);
    const ia = new Uint8Array(ab);
    for(let i=0;i<byteStr.length;i++) ia[i]=byteStr.charCodeAt(i);
    photoFile = new File([new Blob([ab],{type:'image/jpeg'})], 'camera.jpg', {type:'image/jpeg',lastModified:Date.now()});
    showPreview(dataUrl);
}

function galPhoto(input) {
    if(!input.files||!input.files[0]) return;
    const file = input.files[0];
    const img = new Image();
    img.onload = () => {
        let w=img.width,h=img.height;
        if(w>1200||h>1200){if(w>h){h=Math.round(h*1200/w);w=1200;}else{w=Math.round(w*1200/h);h=1200;}}
        const c=document.createElement('canvas');c.width=w;c.height=h;
        c.getContext('2d').drawImage(img,0,0,w,h);
        c.toBlob(b=>{
            photoFile=new File([b],'photo.jpg',{type:'image/jpeg'});
            showPreview(URL.createObjectURL(b));
        },'image/jpeg',0.85);
    };
    img.src = URL.createObjectURL(file);
}

function showPreview(src) {
    document.getElementById('preview-img').src = src;
    document.getElementById('photo-preview').style.display = 'block';
    document.getElementById('capture-btns').style.display = 'none';
    document.getElementById('photo-guide').style.display = 'none';
    document.getElementById('photo-nav').style.display = 'none';
}

function retake() {
    photoFile=null;
    document.getElementById('photo-preview').style.display='none';
    document.getElementById('capture-btns').style.display='flex';
    document.getElementById('photo-guide').style.display='block';
    document.getElementById('photo-nav').style.display='flex';
    document.getElementById('result-area').style.display='none';
    document.getElementById('btn-gen').disabled=false;
    document.getElementById('btn-gen').textContent='‚ú® Generar';
}

// ============================================================
// STEP 4: GENERATE + SHARE
// ============================================================
async function generate(retryCount = 0) {
    if(!photoFile) return;
    const btn = document.getElementById('btn-gen');
    btn.disabled=true; btn.textContent='‚è≥ Generando...';
    document.getElementById('loader').classList.add('visible');
    const bar = document.getElementById('prog-bar');
    bar.style.width = '0%';
    let elapsed=0;
    const timer = setInterval(()=>{
        elapsed+=0.5;
        bar.style.width = Math.min(90,elapsed/12*100)+'%';
        const step = document.getElementById('loader-step');
        if(outfit.top && elapsed<6) step.textContent='üëï Probando superior...';
        else if(outfit.bottom && elapsed<10) step.textContent='üëñ Probando inferior...';
        else step.textContent='‚ú® Finalizando...';
    },500);

    const form = new FormData();
    form.append('model_image', photoFile);
    if(outfit.top) form.append('top_id', outfit.top);
    if(outfit.bottom) form.append('bottom_id', outfit.bottom);
    if(outfit.onepiece) form.append('onepiece_id', outfit.onepiece);

    try {
        const controller = new AbortController();
        setTimeout(()=>controller.abort(), 180000);
        const resp = await fetch('/api/try-on-outfit', {method:'POST',body:form,signal:controller.signal});
        clearInterval(timer); bar.style.width='100%';

        if(!resp.ok) {
            const err = await resp.text();
            if (retryCount < 2) {
                document.getElementById('loader-step').textContent = `üîÑ Reintentando... (${retryCount+1}/2)`;
                bar.style.width = '0%';
                setTimeout(() => generate(retryCount + 1), 1500);
                return;
            }
            document.getElementById('loader').classList.remove('visible');
            btn.disabled=false; btn.textContent='‚ú® Generar';
            toast('Error: '+err.substring(0,100),'error');
            return;
        }

        const data = await resp.json();
        document.getElementById('loader').classList.remove('visible');

        if(data.success) {
            document.getElementById('result-img').src = data.result_image;
            const names = data.garments_used.map(g=>g.name).join(' + ');
            const storeLabel = storeName ? storeName + ' ‚Äî ' : '';
            document.getElementById('result-garments').textContent = storeLabel + names;

            // Store share data
            lastResultId = data.result_id;
            lastShareUrl = window.location.origin + (data.share_url || '');
            lastStoreData = data.store;
            lastGarmentsUsed = data.garments_used || [];

            // Reset feedback state
            currentRating = 0;
            document.querySelectorAll('#stars .star').forEach(s => s.style.opacity = '0.3');
            document.getElementById('feedback-comment').value = '';
            document.getElementById('feedback-section').style.display = 'block';
            document.getElementById('feedback-thanks').style.display = 'none';

            // Update download button
            if (lastResultId) {
                document.getElementById('downloadBtn').href = `/api/share-image/${lastResultId}`;
            }

            goStep(4);
        } else {
            if (retryCount < 2) {
                document.getElementById('loader-step').textContent = `üîÑ Reintentando... (${retryCount+1}/2)`;
                bar.style.width = '0%';
                setTimeout(() => generate(retryCount + 1), 1500);
                return;
            }
            btn.disabled=false; btn.textContent='‚ú® Generar';
            toast('Error generando','error');
        }
    } catch(e) {
        clearInterval(timer);
        if (retryCount < 2) {
            document.getElementById('loader-step').textContent = `üîÑ Reintentando... (${retryCount+1}/2)`;
            bar.style.width = '0%';
            setTimeout(() => generate(retryCount + 1), 2000);
            return;
        }
        document.getElementById('loader').classList.remove('visible');
        btn.disabled=false; btn.textContent='‚ú® Generar';
        toast('Error de conexi√≥n. Intenta de nuevo.','error');
    }
}

// ============================================================
// SHARE FUNCTIONS
// ============================================================
async function logShare(platform) {
    if (!lastResultId) return;
    try {
        const form = new FormData();
        form.append('platform', platform);
        await fetch(`/api/share/${lastResultId}`, { method: 'POST', body: form });
    } catch(e) { /* silent */ }
}

function shareWhatsApp() {
    logShare('whatsapp');
    const ig = lastStoreData?.instagram ? ` @${lastStoreData.instagram}` : '';
    const text = `¬°Mira c√≥mo me queda esto! üî• ${storeName}${ig}\n\n${lastShareUrl}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
}

function shareFacebook() {
    logShare('facebook');
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(lastShareUrl)}`, '_blank');
}

function shareInstagram() {
    logShare('instagram');
    toast('üì∏ Descarga la imagen y s√∫bela a tu historia', 'success');
    setTimeout(() => {
        window.location.href = `/api/share-image/${lastResultId}`;
    }, 800);
}

async function copyShareLink() {
    logShare('copy_link');
    try {
        await navigator.clipboard.writeText(lastShareUrl);
        toast('‚úÖ Link copiado', 'success');
    } catch(e) {
        const input = document.createElement('input');
        input.value = lastShareUrl;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        toast('‚úÖ Link copiado', 'success');
    }
}

// ============================================================
// FEEDBACK + RATING + BUY
// ============================================================
let currentRating = 0;
let lastGarmentsUsed = [];

function setRating(n) {
    currentRating = n;
    document.querySelectorAll('#stars .star').forEach((s, i) => {
        s.style.opacity = i < n ? '1' : '0.3';
    });
}

async function submitFeedback() {
    if (currentRating === 0) { toast('Selecciona una calificaci√≥n', 'error'); return; }
    if (!lastResultId) return;

    const garmentIds = lastGarmentsUsed.map(g => g.id).join(',');
    const comment = document.getElementById('feedback-comment').value.trim();
    const wouldBuy = 'false'; // tracked separately via buy button

    const form = new FormData();
    form.append('result_id', lastResultId);
    form.append('garment_ids', garmentIds);
    form.append('rating', currentRating);
    form.append('comment', comment);
    form.append('would_buy', wouldBuy);

    try {
        const resp = await fetch('/api/feedback', { method: 'POST', body: form });
        const data = await resp.json();
        if (data.success) {
            document.getElementById('feedback-section').style.display = 'none';
            document.getElementById('feedback-thanks').style.display = 'block';
            toast('¬°Gracias por tu opini√≥n!', 'success');
        }
    } catch(e) { toast('Error enviando feedback', 'error'); }
}

function buyWhatsApp() {
    // Log buy intent as feedback
    if (lastResultId) {
        const garmentIds = lastGarmentsUsed.map(g => g.id).join(',');
        const form = new FormData();
        form.append('result_id', lastResultId);
        form.append('garment_ids', garmentIds);
        form.append('rating', currentRating || 5);
        form.append('comment', '');
        form.append('would_buy', 'true');
        fetch('/api/feedback', { method: 'POST', body: form }).catch(() => {});
    }

    // Build WhatsApp message with garment details
    const items = lastGarmentsUsed.map(g => {
        const icon = g.category === 'tops' ? 'üëï' : g.category === 'bottoms' ? 'üëñ' : 'üëó';
        return `${icon} ${g.name} - Talla ${g.size}${g.price ? ` - $${Number(g.price).toLocaleString('es-CO')}` : ''}`;
    }).join('\n');

    const total = lastGarmentsUsed.reduce((sum, g) => sum + (g.price || 0), 0);
    const shareLink = lastShareUrl || '';

    let msg = `¬°Hola! üõí Me prob√© estas prendas con el probador virtual y me gustar√≠a comprarlas:\n\n${items}`;
    if (total > 0) msg += `\n\nüí∞ Total: $${total.toLocaleString('es-CO')}`;
    if (shareLink) msg += `\n\nüì∏ As√≠ me quedaron: ${shareLink}`;

    // Use store phone if available
    const storePhone = lastStoreData?.phone || '';
    const cleanPhone = storePhone.replace(/[^0-9+]/g, '');

    if (cleanPhone) {
        window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
    } else {
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }
}

// ============================================================
// TOAST
// ============================================================
function toast(msg, type='') {
    const t = document.getElementById('toast');
    t.textContent=msg; t.className=`toast visible ${type}`;
    setTimeout(()=>t.classList.remove('visible'),3000);
}
</script>
</body>
</html>
