<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>{{ garment.name }} - Prueba Virtual</title>
    <link rel="manifest" href="/static/manifest.json">
    <meta name="theme-color" content="#c9a55a">
    <meta name="mobile-web-app-capable" content="yes">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0a0a0a; --card: #141414; --border: #2a2520;
            --accent: #c9a55a; --text: #f0ece4; --text2: #8a8578;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'DM Sans',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }

        .container { max-width:480px; margin:0 auto; padding:1rem; }

        .garment-hero {
            position:relative; border-radius:16px; overflow:hidden;
            background:var(--card); border:1px solid var(--border);
            margin-bottom:1.5rem;
        }
        .garment-hero img {
            width:100%; height:auto; max-height:50vh; object-fit:contain;
            background:#1a1a1a;
        }
        .garment-badge {
            position:absolute; top:12px; right:12px;
            background:var(--accent); color:#0a0a0a;
            padding:4px 12px; border-radius:20px;
            font-weight:600; font-size:0.8rem;
        }

        .garment-info { padding:1.5rem; }
        .garment-name {
            font-family:'Playfair Display',serif;
            font-size:1.6rem; font-weight:700; margin-bottom:0.5rem;
        }
        .garment-meta { color:var(--text2); font-size:0.9rem; margin-bottom:0.5rem; }
        .garment-price { font-size:1.3rem; font-weight:600; color:var(--accent); }

        .cta-section {
            background:var(--card); border:1px solid var(--border);
            border-radius:16px; padding:1.5rem; text-align:center;
            margin-bottom:1.5rem;
        }
        .cta-title {
            font-family:'Playfair Display',serif;
            font-size:1.2rem; margin-bottom:0.5rem;
        }
        .cta-subtitle { color:var(--text2); font-size:0.85rem; margin-bottom:1.2rem; }

        .btn-tryon {
            display:block; width:100%; padding:16px;
            background:var(--accent); color:#0a0a0a;
            border:none; border-radius:12px; cursor:pointer;
            font-family:inherit; font-size:1.1rem; font-weight:700;
            margin-bottom:0.75rem;
        }
        .btn-tryon:active { transform:scale(0.98); }
        .btn-tryon:disabled { opacity:0.4; cursor:not-allowed; transform:none; }

        .btn-gallery {
            display:block; width:100%; padding:14px;
            background:transparent; color:var(--text);
            border:1px solid var(--border); border-radius:12px;
            cursor:pointer; font-family:inherit; font-size:0.95rem;
        }

        input[type="file"] { display:none; }

        /* Camera viewfinder */
        .camera-fullscreen {
            display:none; position:fixed; top:0; left:0; right:0; bottom:0;
            z-index:999; background:#000;
        }
        .camera-fullscreen video { width:100%; height:100%; object-fit:cover; }
        .camera-guide {
            position:absolute; top:3%; left:5%; right:5%; bottom:12%;
            border:2px dashed rgba(201,165,90,0.5); border-radius:12px;
            pointer-events:none;
        }
        .camera-guide-text {
            position:absolute; top:0.5%; left:0; right:0; text-align:center;
            color:rgba(255,255,255,0.8); font-size:0.85rem;
            text-shadow:0 1px 4px rgba(0,0,0,0.8); pointer-events:none;
        }
        .camera-buttons {
            position:absolute; bottom:0; left:0; right:0;
            padding:1.5rem 1rem 2.5rem;
            background:linear-gradient(transparent, rgba(0,0,0,0.85));
            display:flex; justify-content:space-around; align-items:center;
        }
        .cam-btn {
            background:rgba(255,255,255,0.15); border:2px solid rgba(255,255,255,0.3);
            color:#fff; padding:14px 20px; border-radius:50px; cursor:pointer;
            font-family:inherit; font-size:1rem; font-weight:600;
            min-width:80px; text-align:center;
        }
        .cam-btn-capture {
            background:var(--accent); border:3px solid #fff; color:#0a0a0a;
            padding:20px 30px; font-size:1.2rem; font-weight:700;
            min-width:120px; box-shadow:0 4px 15px rgba(0,0,0,0.4);
        }

        /* Preview & result */
        .preview-section { display:none; text-align:center; margin-bottom:1.5rem; }
        .preview-section img { max-width:100%; max-height:50vh; border-radius:12px; }
        .preview-actions { display:flex; gap:0.75rem; margin-top:1rem; }
        .preview-actions button { flex:1; padding:14px; border-radius:12px; cursor:pointer; font-family:inherit; font-weight:600; }

        .result-section { display:none; text-align:center; }
        .result-section img { max-width:100%; border-radius:12px; margin-bottom:1rem; }

        .loader { display:none; text-align:center; padding:2rem; }
        .loader.visible { display:block; }
        .spinner { width:50px; height:50px; border:3px solid var(--border); border-top-color:var(--accent); border-radius:50%; animation:spin 0.8s linear infinite; margin:0 auto 1rem; }
        @keyframes spin { to { transform:rotate(360deg); } }
        .progress-bar { width:100%; height:4px; background:var(--border); border-radius:4px; margin-top:12px; overflow:hidden; }
        .progress-fill { height:100%; background:var(--accent); width:0%; transition:width 0.5s; }

        .share-buttons { display:flex; gap:0.75rem; margin-top:1rem; }
        .share-buttons button { flex:1; padding:12px; border-radius:12px; cursor:pointer; font-family:inherit; font-size:0.9rem; }
        .btn-whatsapp { background:#25D366; border:none; color:#fff; font-weight:600; }
        .btn-retry { background:transparent; border:1px solid var(--border); color:var(--text); }
        .btn-browse { background:transparent; border:1px solid var(--accent); color:var(--accent); font-weight:600; }

        /* Combo section */
        .combo-section { display:none; margin-top:1rem; }
        .combo-title { font-family:'Playfair Display',serif; font-size:1.1rem; font-weight:600; margin-bottom:0.5rem; }
        .combo-sub { font-size:0.8rem; color:var(--text2); margin-bottom:0.75rem; }
        .combo-grid { display:grid; grid-template-columns:repeat(3,1fr); gap:0.5rem; }
        .combo-item { background:var(--card); border:2px solid var(--border); border-radius:10px; overflow:hidden; cursor:pointer; transition:all 0.2s; position:relative; }
        .combo-item.selected { border-color:var(--accent); box-shadow:0 0 0 1px var(--accent); }
        .combo-item img { width:100%; height:100px; object-fit:cover; }
        .combo-item .ci-info { padding:4px 6px; }
        .combo-item .ci-name { font-size:0.7rem; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .combo-item .ci-price { font-size:0.7rem; color:var(--accent); }
        .combo-item .ci-check { position:absolute;top:4px;right:4px;width:20px;height:20px;background:var(--accent);border-radius:50%;display:none;align-items:center;justify-content:center;color:#0a0a0a;font-size:0.65rem;font-weight:700; }
        .combo-item.selected .ci-check { display:flex; }
        .combo-selected { display:none; margin-top:0.75rem; padding:0.6rem 0.8rem; background:rgba(201,165,90,0.1); border:1px solid var(--accent); border-radius:10px; font-size:0.8rem; }
        .combo-selected.visible { display:flex; align-items:center; gap:0.5rem; flex-wrap:wrap; }
        .combo-tag { background:var(--accent); color:#0a0a0a; padding:2px 8px; border-radius:12px; font-size:0.75rem; font-weight:600; }

        .powered { text-align:center; color:var(--text2); font-size:0.75rem; margin-top:2rem; padding-bottom:1rem; }
    </style>
</head>
<body>

<div class="container">
    <!-- GARMENT INFO -->
    <div class="garment-hero" id="garment-section">
        <img src="/api/garment-image/{{ garment.id }}" alt="{{ garment.name }}">
        <span class="garment-badge">{{ garment.size }}</span>
        <div class="garment-info">
            {% if store_name %}
            <div style="font-size:0.75rem;color:var(--accent);font-weight:500;margin-bottom:2px;">{{ store_name }}</div>
            {% endif %}
            <div class="garment-name">{{ garment.name }}</div>
            <div class="garment-meta">
                {% if garment.category == 'tops' %}üëï{% elif garment.category == 'bottoms' %}üëñ{% else %}üëó{% endif %}
                {{ garment.category | capitalize }} ¬∑ Talla {{ garment.size }}
            </div>
            {% if garment.price %}
            <div class="garment-price">${{ "{:,.0f}".format(garment.price) }} COP</div>
            {% endif %}
        </div>
    </div>

    <!-- CTA -->
    {% if garment.tryon_enabled %}
    <div class="cta-section" id="cta-section">
        <div class="cta-title">¬øC√≥mo te quedar√≠a?</div>
        <div class="cta-subtitle">Pru√©bate esta prenda sola o comb√≠nala con otra</div>
        <button class="btn-tryon" onclick="startTryOn()">üì∑ Probar solo esta prenda</button>
        {% if garment.category != 'one-pieces' %}
        <button class="btn-gallery" onclick="showCombo()" id="btn-combo">
            {% if garment.category == 'tops' %}üëñ Combinar con prenda inferior{% else %}üëï Combinar con prenda superior{% endif %}
        </button>
        {% endif %}
    </div>
    {% else %}
    <div class="cta-section" id="cta-section">
        <div class="cta-title">üìã Informaci√≥n del producto</div>
        <div class="cta-subtitle">Escanea otros c√≥digos QR con el √≠cono ‚ú® para prob√°rtelos virtualmente</div>
        {% if store_name %}
        <button class="btn-gallery" onclick="window.location.href=STORE_ID ? '/tienda?store='+STORE_ID : '/tienda'">üëó Ver cat√°logo de {{ store_name }}</button>
        {% endif %}
    </div>
    {% endif %}

    <!-- COMBO: select complementary garment -->
    <div class="combo-section" id="combo-section">
        <div class="combo-title" id="combo-title">
            {% if garment.category == 'tops' %}üëñ Escoge prenda inferior{% else %}üëï Escoge prenda superior{% endif %}
        </div>
        <div class="combo-sub">De {{ store_name or 'esta tienda' }}</div>
        <div class="combo-grid" id="combo-grid"></div>
        <div class="combo-selected" id="combo-selected">
            <span>Tu outfit:</span>
            <span class="combo-tag" id="combo-tag-main">
                {% if garment.category == 'tops' %}üëï{% else %}üëñ{% endif %} {{ garment.name }}
            </span>
            <span class="combo-tag" id="combo-tag-extra"></span>
        </div>
        <div style="display:flex;gap:0.75rem;margin-top:0.75rem;">
            <button class="btn-retry" onclick="hideCombo()">‚Üê Atr√°s</button>
            <button class="btn-tryon" id="btn-combo-go" style="display:none;" onclick="startTryOn()">üì∑ Probar outfit</button>
        </div>
    </div>

    <!-- CAPTURE BUTTONS (hidden until startTryOn) -->
    <div id="capture-section" style="display:none;">
        <div style="background:var(--card);border:1px solid var(--border);border-radius:16px;padding:1.5rem;text-align:center;margin-top:1rem;">
            <div class="cta-title" style="margin-bottom:0.3rem;">üì∑ Tu foto</div>
            <div class="cta-subtitle">Foto de cuerpo completo para la prueba virtual</div>
            <div id="outfit-summary" style="margin-bottom:1rem;padding:0.5rem;background:rgba(201,165,90,0.1);border-radius:8px;font-size:0.8rem;color:var(--accent);"></div>
            <button class="btn-tryon" onclick="openCamera()">üì∑ Tomar foto con c√°mara</button>
            <button class="btn-gallery" onclick="document.getElementById('gallery-input').click()">üñºÔ∏è Elegir foto de galer√≠a</button>
        </div>
    </div>
    <input type="file" id="gallery-input" accept="image/*" onchange="handlePhoto(this)" style="display:none;">

    <!-- PHOTO PREVIEW -->
    <div class="preview-section" id="preview-section">
        <img id="preview-img" alt="Tu foto">
        <div class="preview-actions">
            <button onclick="retake()" class="btn-retry">üîÑ Otra foto</button>
            <button onclick="generate()" class="btn-tryon" id="btn-gen">‚ú® Ver c√≥mo me queda</button>
        </div>
    </div>

    <!-- LOADER -->
    <div class="loader" id="loader">
        <div class="spinner"></div>
        <div id="loader-text" style="color:var(--text2);">Generando tu prueba virtual...</div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill"></div></div>
        <div id="loader-step" style="font-size:0.75rem; color:var(--text2); margin-top:8px;"></div>
    </div>

    <!-- RESULT -->
    <div class="result-section" id="result-section">
        <h2 style="font-family:'Playfair Display',serif; margin-bottom:1rem;">¬°As√≠ te queda!</h2>
        <img id="result-img" alt="Resultado">
        <div class="share-buttons">
            <button class="btn-whatsapp" onclick="shareWhatsApp()">üí¨ Compartir</button>
            <button class="btn-retry" onclick="retake()">üîÑ Otra foto</button>
        </div>
        <button class="btn-browse" onclick="window.location.href=STORE_ID ? '/tienda?store='+STORE_ID : '/tienda'" style="width:100%; margin-top:0.75rem;">üëó Ver m√°s prendas</button>
    </div>

    <div class="powered">Powered by Fashion TryOn ‚ú®</div>
</div>

<!-- CAMERA FULLSCREEN -->
<div class="camera-fullscreen" id="camera-view">
    <video id="cam-video" autoplay playsinline muted></video>
    <div class="camera-guide"></div>
    <div class="camera-guide-text">Ubica tu cuerpo completo dentro del recuadro</div>
    <div class="camera-buttons">
        <button class="cam-btn" onclick="switchCam()">üîÑ<br><span style="font-size:0.75rem;">Voltear</span></button>
        <button class="cam-btn cam-btn-capture" onclick="capture()">üì∏ Capturar</button>
        <button class="cam-btn" onclick="closeCamera()">‚úï<br><span style="font-size:0.75rem;">Cerrar</span></button>
    </div>
</div>
<canvas id="cam-canvas" style="display:none;"></canvas>

<script>
    const GARMENT_ID = '{{ garment.id }}';
    const GARMENT_CATEGORY = '{{ garment.category }}';
    const GARMENT_GENDER = '{{ garment.gender }}';
    const STORE_ID = '{{ garment.store_id or "" }}';
    let photoFile = null;
    let camStream = null;
    let frontCam = false;
    let comboId = null;
    let comboGarments = [];

    // Combo: load complementary garments (same store, same gender)
    async function showCombo() {
        document.getElementById('cta-section').style.display = 'none';
        document.getElementById('combo-section').style.display = 'block';

        if (comboGarments.length) { renderCombo(); return; }

        const complementary = GARMENT_CATEGORY === 'tops' ? 'bottoms' : 'tops';
        let params = [];
        if (GARMENT_GENDER) params.push(`gender=${GARMENT_GENDER}`);
        if (STORE_ID) params.push(`store_id=${STORE_ID}`);
        const query = params.length ? '?' + params.join('&') : '';

        try {
            const r = await fetch(`/api/catalog${query}`);
            const data = await r.json();
            const all = data.garments || [];
            comboGarments = all.filter(g => g.category === complementary && g.id !== GARMENT_ID && g.tryon_enabled);
            renderCombo();
        } catch(e) { }
    }

    function renderCombo() {
        const grid = document.getElementById('combo-grid');
        if (!comboGarments.length) {
            grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:1rem;color:var(--text2);font-size:0.8rem;">No hay prendas complementarias disponibles</div>';
            return;
        }
        grid.innerHTML = comboGarments.map(g => {
            const icon = g.category === 'tops' ? 'üëï' : 'üëñ';
            const sel = g.id === comboId;
            return `<div class="combo-item ${sel?'selected':''}" onclick="selectCombo('${g.id}')">
                <div class="ci-check">‚úì</div>
                <img src="${g.image_url}" alt="${g.name}">
                <div class="ci-info"><div class="ci-name">${g.name}</div>${g.price?`<div class="ci-price">$${Number(g.price).toLocaleString('es-CO')}</div>`:''}</div>
            </div>`;
        }).join('');
    }

    function selectCombo(id) {
        comboId = comboId === id ? null : id;
        renderCombo();
        const bar = document.getElementById('combo-selected');
        const btn = document.getElementById('btn-combo-go');
        if (comboId) {
            const g = comboGarments.find(x => x.id === comboId);
            const icon = g.category === 'tops' ? 'üëï' : 'üëñ';
            document.getElementById('combo-tag-extra').textContent = `${icon} ${g.name}`;
            bar.classList.add('visible');
            btn.style.display = 'block';
        } else {
            bar.classList.remove('visible');
            btn.style.display = 'none';
        }
    }

    function hideCombo() {
        document.getElementById('combo-section').style.display = 'none';
        document.getElementById('cta-section').style.display = 'block';
    }

    function startTryOn() {
        document.getElementById('cta-section').style.display = 'none';
        document.getElementById('combo-section').style.display = 'none';

        // Show what will be tried on
        const summary = document.getElementById('outfit-summary');
        const mainIcon = GARMENT_CATEGORY === 'tops' ? 'üëï' : GARMENT_CATEGORY === 'bottoms' ? 'üëñ' : 'üëó';
        let text = mainIcon + ' {{ garment.name }}';
        if (comboId) {
            const g = comboGarments.find(x => x.id === comboId);
            if (g) {
                const comboIcon = g.category === 'tops' ? 'üëï' : 'üëñ';
                text += ' + ' + comboIcon + ' ' + g.name;
            }
        }
        summary.textContent = text;

        const capture = document.getElementById('capture-section');
        capture.style.display = 'block';
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Camera
    async function openCamera() {
        try {
            camStream = await navigator.mediaDevices.getUserMedia({
                video: { facingMode: frontCam ? 'user' : 'environment', width:{ideal:1280}, height:{ideal:1920} },
                audio: false
            });
            document.getElementById('cam-video').srcObject = camStream;
            document.getElementById('camera-view').style.display = 'block';
        } catch(e) {
            alert('No se pudo abrir la c√°mara. Usa la galer√≠a.');
        }
    }

    function switchCam() { frontCam = !frontCam; closeCamera(); openCamera(); }

    function closeCamera() {
        if (camStream) camStream.getTracks().forEach(t => t.stop());
        camStream = null;
        document.getElementById('cam-video').srcObject = null;
        document.getElementById('camera-view').style.display = 'none';
    }

    function capture() {
        const video = document.getElementById('cam-video');
        const canvas = document.getElementById('cam-canvas');
        if (!video.videoWidth) return;

        let w = video.videoWidth, h = video.videoHeight;
        if (w > 1200 || h > 1200) {
            if (w > h) { h = Math.round(h*1200/w); w=1200; }
            else { w = Math.round(w*1200/h); h=1200; }
        }
        canvas.width = w; canvas.height = h;
        canvas.getContext('2d').drawImage(video, 0, 0, w, h);
        closeCamera();

        const dataUrl = canvas.toDataURL('image/jpeg', 0.85);
        const byteStr = atob(dataUrl.split(',')[1]);
        const ab = new ArrayBuffer(byteStr.length);
        const ia = new Uint8Array(ab);
        for (let i=0; i<byteStr.length; i++) ia[i] = byteStr.charCodeAt(i);

        photoFile = new File([new Blob([ab], {type:'image/jpeg'})], 'camera.jpg', {type:'image/jpeg', lastModified:Date.now()});
        showPreview(dataUrl);
    }

    // Gallery
    function handlePhoto(input) {
        if (!input.files || !input.files[0]) return;
        const file = input.files[0];
        // Compress
        const img = new Image();
        img.onload = () => {
            let w=img.width, h=img.height;
            if (w>1200||h>1200) { if(w>h){h=Math.round(h*1200/w);w=1200;}else{w=Math.round(w*1200/h);h=1200;} }
            const c = document.createElement('canvas'); c.width=w; c.height=h;
            c.getContext('2d').drawImage(img,0,0,w,h);
            c.toBlob(b => {
                photoFile = new File([b], 'photo.jpg', {type:'image/jpeg'});
                showPreview(URL.createObjectURL(b));
            }, 'image/jpeg', 0.85);
        };
        img.src = URL.createObjectURL(file);
    }

    function showPreview(src) {
        document.getElementById('preview-img').src = src;
        document.getElementById('cta-section').style.display = 'none';
        document.getElementById('combo-section').style.display = 'none';
        document.getElementById('capture-section').style.display = 'none';
        document.getElementById('preview-section').style.display = 'block';
        document.getElementById('result-section').style.display = 'none';
    }

    function retake() {
        photoFile = null;
        document.getElementById('preview-section').style.display = 'none';
        document.getElementById('result-section').style.display = 'none';
        document.getElementById('loader').classList.remove('visible');
        document.getElementById('capture-section').style.display = 'block';
        document.getElementById('btn-gen').disabled = false;
        document.getElementById('btn-gen').textContent = comboId ? '‚ú® Probar outfit' : '‚ú® Ver c√≥mo me queda';
    }

    // Generate with auto-retry
    async function generate(retryCount = 0) {
        if (!photoFile) return;
        const btn = document.getElementById('btn-gen');
        btn.disabled = true; btn.textContent = '‚è≥ Generando...';

        document.getElementById('preview-section').style.display = 'none';
        const loader = document.getElementById('loader');
        loader.classList.add('visible');
        document.getElementById('loader-step').textContent = 'üëó Prob√°ndote la prenda...';

        const bar = document.getElementById('progress-fill');
        bar.style.width = '0%';
        let elapsed = 0;
        const timer = setInterval(() => {
            elapsed += 0.5;
            bar.style.width = Math.min(90, elapsed/12*100) + '%';
            if (elapsed > 6) document.getElementById('loader-step').textContent = '‚ú® Finalizando...';
        }, 500);

        const form = new FormData();
        form.append('model_image', photoFile);

        // Main garment
        if (GARMENT_CATEGORY === 'one-pieces') {
            form.append('onepiece_id', GARMENT_ID);
        } else if (GARMENT_CATEGORY === 'tops') {
            form.append('top_id', GARMENT_ID);
            // Add combo bottom if selected
            if (comboId) form.append('bottom_id', comboId);
        } else {
            form.append('bottom_id', GARMENT_ID);
            // Add combo top if selected
            if (comboId) form.append('top_id', comboId);
        }

        try {
            const controller = new AbortController();
            setTimeout(() => controller.abort(), 180000);
            const resp = await fetch('/api/try-on-outfit', { method:'POST', body:form, signal:controller.signal });
            clearInterval(timer);
            bar.style.width = '100%';

            if (!resp.ok) {
                if (retryCount < 2) {
                    document.getElementById('loader-step').textContent = `üîÑ Reintentando... (${retryCount+1}/2)`;
                    bar.style.width = '0%';
                    setTimeout(() => generate(retryCount + 1), 1500);
                    return;
                }
                const err = await resp.text();
                loader.classList.remove('visible');
                document.getElementById('preview-section').style.display = 'block';
                btn.disabled = false; btn.textContent = '‚ú® Ver c√≥mo me queda';
                alert('Error: ' + err.substring(0, 100));
                return;
            }

            const data = await resp.json();
            loader.classList.remove('visible');

            if (data.success) {
                document.getElementById('result-img').src = data.result_image;
                document.getElementById('result-section').style.display = 'block';
            } else {
                if (retryCount < 2) {
                    document.getElementById('loader-step').textContent = `üîÑ Reintentando... (${retryCount+1}/2)`;
                    bar.style.width = '0%';
                    setTimeout(() => generate(retryCount + 1), 1500);
                    return;
                }
                document.getElementById('preview-section').style.display = 'block';
                btn.disabled = false; btn.textContent = '‚ú® Ver c√≥mo me queda';
                alert('Error generando la prueba');
            }
        } catch(e) {
            clearInterval(timer);
            if (retryCount < 2) {
                document.getElementById('loader-step').textContent = `üîÑ Reintentando... (${retryCount+1}/2)`;
                bar.style.width = '0%';
                setTimeout(() => generate(retryCount + 1), 2000);
                return;
            }
            loader.classList.remove('visible');
            document.getElementById('preview-section').style.display = 'block';
            btn.disabled = false; btn.textContent = '‚ú® Ver c√≥mo me queda';
            alert('Error de conexi√≥n. Intenta de nuevo.');
        }
    }

    // Share result IMAGE via WhatsApp (not just link)
    async function shareWhatsApp() {
        const img = document.getElementById('result-img');
        try {
            const resp = await fetch(img.src);
            const blob = await resp.blob();
            const file = new File([blob], 'mi-look-virtual.jpg', { type: 'image/jpeg' });

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    title: '¬°Mira c√≥mo me queda!',
                    text: '¬°Mira c√≥mo me queda esta prenda! üëó‚ú®',
                    files: [file]
                });
            } else {
                // Fallback: download + open WhatsApp
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'mi-look-virtual.jpg';
                a.click();
                setTimeout(() => {
                    window.open('https://wa.me/?text=' + encodeURIComponent('¬°Mira c√≥mo me queda esta prenda! üëó‚ú®'), '_blank');
                }, 1000);
            }
        } catch(e) {
            window.open('https://wa.me/?text=' + encodeURIComponent('¬°Mira c√≥mo me queda esta prenda! üëó‚ú®\n' + window.location.href), '_blank');
        }
    }
</script>
</body>
</html>
