<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fashion Admin - Panel de Control</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&family=Fraunces:opsz,wght@9..144,400;9..144,600;9..144,700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg: #0c0b0f; --surface: #16151a; --card: #1a191f;
            --border: #2a2930; --accent: #d4a853; --accent-soft: rgba(212,168,83,0.12);
            --green: #4ade80; --green-soft: rgba(74,222,128,0.12);
            --red: #f87171; --red-soft: rgba(248,113,113,0.12);
            --blue: #60a5fa; --blue-soft: rgba(96,165,250,0.12);
            --text: #eae6df; --text-mid: #9a9590; --text-dim: #5c5856;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Outfit', sans-serif; background: var(--bg); color: var(--text); min-height: 100vh; }
        .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 14px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; z-index: 50; }
        .logo { font-family: 'Fraunces', serif; font-size: 22px; }
        .logo span:first-child { color: var(--accent); font-weight: 700; letter-spacing: 1px; }
        .logo span:last-child { color: var(--text); font-weight: 400; margin-left: 6px; }
        .header-right { display: flex; align-items: center; gap: 12px; }
        .header-badge { background: var(--card); border: 1px solid var(--border); border-radius: 20px; padding: 6px 14px; font-size: 13px; }
        .header-badge span:first-child { color: var(--text-mid); }
        .header-badge span:last-child { color: var(--accent); font-weight: 600; }
        .layout { display: flex; min-height: calc(100vh - 55px); }
        .sidebar { width: 200px; background: var(--surface); border-right: 1px solid var(--border); padding: 16px 0; flex-shrink: 0; }
        .nav-item { display: flex; align-items: center; gap: 10px; padding: 11px 20px; cursor: pointer; font-size: 14px; color: var(--text-mid); border-right: 2px solid transparent; transition: all 0.2s; }
        .nav-item:hover { color: var(--text); background: rgba(255,255,255,0.03); }
        .nav-item.active { color: var(--accent); font-weight: 600; background: var(--accent-soft); border-right-color: var(--accent); }
        .main { flex: 1; padding: 28px; max-width: 1100px; overflow: auto; }
        .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 24px; }
        .stat-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 18px; }
        .stat-label { font-size: 11px; color: var(--text-mid); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 8px; }
        .stat-value { font-size: 24px; font-weight: 700; }
        .stat-value.accent { color: var(--accent); } .stat-value.red { color: var(--red); }
        .stat-value.green { color: var(--green); } .stat-value.blue { color: var(--blue); }
        table { width: 100%; border-collapse: collapse; font-size: 13px; }
        th { padding: 10px 8px; text-align: left; color: var(--text-mid); font-weight: 500; border-bottom: 1px solid var(--border); }
        td { padding: 10px 8px; border-bottom: 1px solid var(--border); }
        .badge { display: inline-flex; align-items: center; gap: 4px; padding: 3px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; }
        .badge-foto { background: var(--accent-soft); color: var(--accent); }
        .badge-video { background: var(--blue-soft); color: var(--blue); }
        .badge-margin-high { background: var(--green-soft); color: var(--green); }
        .badge-margin-mid { background: var(--blue-soft); color: var(--blue); }
        .badge-margin-low { background: var(--red-soft); color: var(--red); }
        .section { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 20px; margin-bottom: 20px; }
        .section-title { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 14px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px; }
        h2 { font-family: 'Fraunces', serif; font-size: 26px; font-weight: 600; margin-bottom: 24px; }
        .btn { display: inline-flex; align-items: center; gap: 6px; border: none; border-radius: 8px; padding: 8px 16px; font-size: 13px; font-weight: 600; cursor: pointer; font-family: 'Outfit', sans-serif; transition: all 0.2s; }
        .btn-primary { background: var(--accent); color: var(--bg); }
        .btn-primary:hover { filter: brightness(1.1); }
        .btn-secondary { background: var(--card); border: 1px solid var(--border); color: var(--text-mid); }
        .btn-secondary:hover { border-color: var(--accent); color: var(--text); }
        .btn-danger { background: var(--red-soft); color: var(--red); }
        .btn-sm { padding: 5px 10px; font-size: 12px; }
        .btn-back { background: var(--card); border: 1px solid var(--border); color: var(--text-mid); margin-right: 12px; }
        select, input { background: var(--bg); border: 1px solid var(--border); color: var(--text); border-radius: 8px; padding: 9px 12px; font-size: 14px; font-family: 'Outfit', sans-serif; width: 100%; }
        select:focus, input:focus { outline: none; border-color: var(--accent); }
        .form-group { margin-bottom: 14px; }
        .form-label { font-size: 12px; color: var(--text-mid); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: var(--surface); border: 1px solid var(--border); border-radius: 16px; padding: 28px; width: 440px; max-height: 90vh; overflow-y: auto; }
        .modal-title { font-family: 'Fraunces', serif; font-size: 20px; font-weight: 600; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .modal-close { background: none; border: none; color: var(--text-mid); cursor: pointer; font-size: 20px; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; margin-bottom: 20px; }
        .info-row { display: flex; justify-content: space-between; padding: 6px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-mid); }
        .info-value { font-weight: 600; }
        tfoot td { padding-top: 14px; font-weight: 700; font-size: 14px; border-top: 2px solid var(--accent); border-bottom: none; }
        .credits-box { background: var(--accent-soft); border: 1px solid rgba(212,168,83,0.3); border-radius: 10px; padding: 12px 16px; display: flex; align-items: center; gap: 10px; margin-bottom: 20px; }
        .credits-box .label { font-size: 13px; color: var(--text-mid); }
        .credits-box .value { font-size: 20px; font-weight: 700; color: var(--accent); }
        .hidden { display: none !important; }
        .store-card { background: var(--card); border: 1px solid var(--border); border-radius: 14px; padding: 16px 20px; margin-bottom: 12px; cursor: pointer; transition: all 0.2s; }
        .store-card:hover { border-color: var(--accent); }
        .store-card-name { font-weight: 700; font-size: 16px; }
        .copy-btn { background: none; border: 1px solid var(--border); color: var(--text-mid); border-radius: 4px; padding: 2px 8px; font-size: 11px; cursor: pointer; font-family: inherit; margin-left: 4px; }
        .copy-btn:hover { border-color: var(--accent); color: var(--accent); }
        @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } .grid-2 { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

<div class="header">
    <div class="logo"><span>FASHION</span><span>Admin</span></div>
    <div class="header-right">
        <select id="planSelect" onchange="updatePlan()" style="width:auto">
            <option value="ondemand">On-Demand ($0.075)</option>
            <option value="tier1" selected>Tier I ($0.0675)</option>
            <option value="tier2">Tier II ($0.060)</option>
            <option value="tier3">Tier III ($0.0488)</option>
        </select>
        <div class="header-badge"><span>CrÃ©ditos FASHN: </span><span id="fashnCredits">...</span></div>
        <a href="/" class="btn btn-secondary btn-sm">â† Try-On App</a>
    </div>
</div>

<div class="layout">
    <div class="sidebar">
        <div class="nav-item active" onclick="showTab('overview')" data-tab="overview">ğŸ“Š Resumen</div>
        <div class="nav-item" onclick="showTab('stores')" data-tab="stores">ğŸª Tiendas</div>
        <div class="nav-item" onclick="showTab('qrcodes')" data-tab="qrcodes">ğŸ“± QR Codes</div>
        <div class="nav-item" onclick="showTab('billing')" data-tab="billing">ğŸ’° FacturaciÃ³n</div>
        <div class="nav-item" onclick="showTab('activity')" data-tab="activity">ğŸ“‹ Actividad</div>
    </div>

    <div class="main">

        <!-- â•â•â• OVERVIEW â•â•â• -->
        <div id="tab-overview">
            <h2>Resumen General</h2>
            <div class="credits-box"><span class="label">CrÃ©ditos FASHN disponibles:</span><span class="value" id="creditsOverview">...</span></div>
            <div class="stats-grid" id="overviewStats"></div>
            <div class="grid-2">
                <div class="section">
                    <div class="section-title">Uso por tipo</div>
                    <div style="display:flex;gap:16px">
                        <div style="flex:1;text-align:center;padding:16px;background:var(--accent-soft);border-radius:10px">
                            <div style="font-size:28px;font-weight:700" id="statFotos">0</div>
                            <div style="font-size:12px;color:var(--text-mid)">ğŸ“· Try-Ons</div>
                        </div>
                        <div style="flex:1;text-align:center;padding:16px;background:var(--blue-soft);border-radius:10px">
                            <div style="font-size:28px;font-weight:700" id="statVideos">0</div>
                            <div style="font-size:12px;color:var(--text-mid)">ğŸ¬ Videos</div>
                        </div>
                    </div>
                </div>
                <div class="section">
                    <div class="section-title">Tabla de crÃ©ditos</div>
                    <div class="info-row"><span class="info-label">Virtual Try-On</span><span class="info-value" style="color:var(--accent)">1 crÃ©dito</span></div>
                    <div class="info-row"><span class="info-label">Video 480p</span><span class="info-value" style="color:var(--accent)">1 crÃ©dito</span></div>
                    <div class="info-row"><span class="info-label">Video 720p</span><span class="info-value" style="color:var(--accent)">3 crÃ©ditos</span></div>
                    <div class="info-row"><span class="info-label">Video 1080p</span><span class="info-value" style="color:var(--accent)">6 crÃ©ditos</span></div>
                </div>
            </div>
        </div>

        <!-- â•â•â• STORES LIST â•â•â• -->
        <div id="tab-stores" class="hidden">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                <h2 style="margin-bottom:0">ğŸª Tiendas</h2>
                <button class="btn btn-primary" onclick="showModal('addStore')">+ Nueva tienda</button>
            </div>
            <div id="storesList"></div>
        </div>

        <!-- â•â•â• STORE DETAIL â•â•â• -->
        <div id="tab-store-detail" class="hidden">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:24px">
                <button class="btn btn-back" onclick="showTab('stores')">â† Volver</button>
                <h2 style="margin-bottom:0" id="storeDetailName"></h2>
            </div>
            <div class="section" style="margin-bottom:16px;"><div class="section-title">ğŸ”— Links de acceso</div><div id="storeAccessLinks"></div></div>
            <div class="grid-2" id="storeDetailInfo"></div>
            <div class="stats-grid" id="storeDetailStats"></div>
            <div class="section">
                <div class="section-header">
                    <div class="section-title">ğŸ“¦ CatÃ¡logo de prendas</div>
                    <div style="display:flex;gap:8px;">
                        <button class="btn btn-primary btn-sm" onclick="showModal('addGarment')">+ Subir prenda</button>
                        <button class="btn btn-sm" style="background:var(--blue-soft);color:var(--blue);border:1px solid var(--blue);" onclick="downloadAllQR()">ğŸ“± QR</button>
                        <a id="storeLinkBtn" href="#" target="_blank" class="btn btn-sm" style="background:var(--green-soft);color:var(--green);border:1px solid var(--green);text-decoration:none;">ğŸ‘ï¸ Ver tienda</a>
                    </div>
                </div>
                <div id="storeGarments" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;margin-top:12px;"></div>
            </div>
            <div class="section">
                <div class="section-header">
                    <div class="section-title">Historial de uso</div>
                    <button class="btn btn-primary btn-sm" onclick="showModal('addUsage')">+ Registrar uso</button>
                </div>
                <table><thead><tr><th>Fecha</th><th>Tipo</th><th>Prendas</th><th>CrÃ©ditos</th><th>Costo</th><th>Cobrar</th><th>Notas</th><th></th></tr></thead><tbody id="storeDetailLogs"></tbody></table>
            </div>
        </div>

        <!-- â•â•â• QR CODES â•â•â• -->
        <div id="tab-qrcodes" class="hidden">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                <h2 style="margin-bottom:0">ğŸ“± CÃ³digos QR</h2>
                <a href="/api/garments/qr-all" download class="btn btn-primary" style="text-decoration:none;">â¬‡ï¸ Descargar todos</a>
            </div>
            <div class="section"><div class="section-title">QR por prenda</div><div id="qr-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;"></div></div>
        </div>

        <!-- â•â•â• BILLING â•â•â• -->
        <div id="tab-billing" class="hidden">
            <h2>FacturaciÃ³n por tienda</h2>
            <div class="section"><table>
                <thead><tr><th>Tienda</th><th style="text-align:center">Fotos</th><th style="text-align:center">Videos</th><th style="text-align:center">CrÃ©ditos</th><th style="text-align:right">Tu costo</th><th style="text-align:right">Cobrar</th><th style="text-align:right">Ganancia</th><th style="text-align:right">Margen</th></tr></thead>
                <tbody id="billingTable"></tbody><tfoot id="billingTotals"></tfoot>
            </table></div>
        </div>

        <!-- â•â•â• ACTIVITY â•â•â• -->
        <div id="tab-activity" class="hidden">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px">
                <h2 style="margin-bottom:0">Actividad reciente</h2>
                <button class="btn btn-primary" onclick="showModal('addUsage')">+ Registrar uso</button>
            </div>
            <div class="section"><table>
                <thead><tr><th>Fecha</th><th>Tienda</th><th>Tipo</th><th>Prendas</th><th>CrÃ©ditos</th><th>Costo</th><th>Cobro</th><th>Notas</th><th></th></tr></thead>
                <tbody id="activityTable"></tbody>
            </table></div>
        </div>
    </div>
</div>

<!-- MODAL: ADD STORE -->
<div id="modal-addStore" class="modal-overlay hidden" onclick="if(event.target===this)closeModal()">
    <div class="modal" style="max-width:480px;">
        <div class="modal-header"><div class="modal-title">ğŸª Nueva tienda</div><button class="modal-close" onclick="closeModal()">âœ•</button></div>
        <div class="form-group"><div class="form-label">Nombre de la tienda</div><input id="newStoreName" placeholder="Boutique MarÃ­a"></div>
        <div class="form-group"><div class="form-label">Slug (URL)</div><input id="newStoreSlug" placeholder="boutique-maria" oninput="this.value=this.value.toLowerCase().replace(/[^a-z0-9-]/g,'')"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="form-group"><div class="form-label">TelÃ©fono WhatsApp</div><input id="newStorePhone" placeholder="+573001234567"></div>
            <div class="form-group"><div class="form-label">Email</div><input id="newStoreEmail" placeholder="info@tienda.com"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="form-group"><div class="form-label">Instagram (sin @)</div><input id="newStoreIG" placeholder="boutique_maria"></div>
            <div class="form-group"><div class="form-label">Website</div><input id="newStoreWeb" placeholder="https://tienda.com"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="form-group"><div class="form-label">Color de marca</div><input id="newStoreColor" type="color" value="#c9a55a" style="height:42px;padding:4px;"></div>
            <div class="form-group"><div class="form-label">ContraseÃ±a panel</div><input id="newStorePass" placeholder="auto-generada si vacÃ­a"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="form-group"><div class="form-label">Precio por outfit (COP)</div><input id="newStoreOutfit" type="number" value="2000"></div>
            <div class="form-group"><div class="form-label">Precio por video (COP)</div><input id="newStoreVideo" type="number" value="5000"></div>
        </div>
        <div class="form-group"><div class="form-label">DirecciÃ³n (opcional)</div><input id="newStoreAddr" placeholder="Calle 123 #45-67, MedellÃ­n"></div>
        <div class="form-group"><div class="form-label">Logo (opcional)</div><input type="file" id="newStoreLogo" accept="image/*" style="padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;width:100%;color:var(--text);"></div>
        <button class="btn btn-primary" style="width:100%;margin-top:8px;padding:12px;font-size:15px" onclick="createStore()">ğŸª Crear tienda</button>
    </div>
</div>

<!-- MODAL: ADD USAGE -->
<div id="modal-addUsage" class="modal-overlay hidden" onclick="if(event.target===this)closeModal()">
    <div class="modal">
        <div class="modal-header"><div class="modal-title">Registrar uso</div><button class="modal-close" onclick="closeModal()">âœ•</button></div>
        <div class="form-group"><div class="form-label">Tienda</div><select id="usageStore"></select></div>
        <div class="form-group"><div class="form-label">Tipo</div>
            <select id="usageType"><option value="tryon">Virtual Try-On (1 crÃ©dito)</option><option value="video-480p">Video 480p</option><option value="video-720p">Video 720p</option><option value="video-1080p">Video 1080p</option></select>
        </div>
        <div class="form-group" id="creditsGroup"><div class="form-label">CrÃ©ditos</div>
            <select id="usageCredits"><option value="1">1 crÃ©dito (prenda sola)</option><option value="2">2 crÃ©ditos (outfit)</option></select>
        </div>
        <div class="form-group"><div class="form-label">Prendas</div><input id="usageGarments" placeholder="Camiseta verde + Jean negro"></div>
        <div class="form-group"><div class="form-label">Notas</div><input id="usageNotes" placeholder="Outfit completo..."></div>
        <button class="btn btn-primary" style="width:100%;margin-top:8px;padding:12px;font-size:15px" onclick="createUsage()">Registrar</button>
    </div>
</div>

<!-- MODAL: ADD GARMENT -->
<div id="modal-addGarment" class="modal-overlay hidden" onclick="if(event.target===this)closeModal()">
    <div class="modal" style="max-width:500px;">
        <div class="modal-header"><div class="modal-title">Subir prenda</div><button class="modal-close" onclick="closeModal()">âœ•</button></div>
        <div class="form-group"><div class="form-label">Nombre</div><input id="gcName" placeholder="Camiseta negra bÃ¡sica"></div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="form-group"><div class="form-label">CategorÃ­a</div>
                <select id="gcCategory"><option value="" disabled selected>Seleccionar...</option>
                    <optgroup label="ğŸ‘• Superior"><option value="tops">Camiseta</option><option value="tops">Camisa</option><option value="tops">Buzo / Saco</option><option value="tops">Blusa</option></optgroup>
                    <optgroup label="ğŸ‘– Inferior"><option value="bottoms">PantalÃ³n</option><option value="bottoms">Pantaloneta</option><option value="bottoms">Falda</option></optgroup>
                    <optgroup label="ğŸ‘— Completo"><option value="one-pieces">Vestido</option><option value="one-pieces">Enterizo</option></optgroup>
                </select></div>
            <div class="form-group"><div class="form-label">GÃ©nero</div><select id="gcGender"><option value="mujer">Mujer</option><option value="hombre">Hombre</option><option value="unisex">Unisex</option></select></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;">
            <div class="form-group"><div class="form-label">Talla</div><select id="gcSize"><option>XS</option><option>S</option><option selected>M</option><option>L</option><option>XL</option></select></div>
            <div class="form-group"><div class="form-label">Precio (COP)</div><input id="gcPrice" type="number" value="0"></div>
            <div class="form-group"><div class="form-label">Referencia</div><input id="gcRef" placeholder="REF-001"></div>
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
            <div class="form-group"><div class="form-label">Color</div><input id="gcColor" placeholder="Negro"></div>
            <div class="form-group"><div class="form-label">Material</div><input id="gcMaterial" placeholder="AlgodÃ³n"></div>
        </div>
        <div class="form-group"><div class="form-label">Foto</div><input type="file" id="gcImage" accept="image/*" style="padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;width:100%;color:var(--text);"></div>
        <button class="btn btn-primary" style="width:100%;margin-top:8px;padding:12px;font-size:15px" onclick="uploadGarment()">ğŸ“¦ Subir prenda</button>
    </div>
</div>

<script>
let dashData={}, storesData=[], logsData=[];
let selectedStoreId=null;
const COP=(n)=>new Intl.NumberFormat('es-CO',{style:'currency',currency:'COP',minimumFractionDigits:0}).format(n);

function showTab(tab){
    document.querySelectorAll('.main > div[id^="tab-"]').forEach(el=>el.classList.add('hidden'));
    document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
    if(tab==='store-detail'){document.getElementById('tab-store-detail').classList.remove('hidden');}
    else{document.getElementById(`tab-${tab}`).classList.remove('hidden');document.querySelector(`.nav-item[data-tab="${tab}"]`)?.classList.add('active');}
    if(tab==='overview')loadDashboard(); if(tab==='stores')loadStores(); if(tab==='billing')loadBilling(); if(tab==='activity')loadActivity(); if(tab==='qrcodes')loadQRCodes();
}
function showModal(id){document.getElementById(`modal-${id}`).classList.remove('hidden');if(id==='addUsage')populateStoreSelect();}
function closeModal(){document.querySelectorAll('.modal-overlay').forEach(el=>el.classList.add('hidden'));}
async function api(url,method='GET',body=null){const opts={method};if(body){opts.body=body instanceof FormData?body:new URLSearchParams(body);}return(await fetch(url,opts)).json();}
function copyText(text,e){navigator.clipboard.writeText(text).then(()=>{if(e){e.textContent='âœ…';setTimeout(()=>e.textContent='ğŸ“‹',1500);}});}

// â•â•â• STORES â•â•â•
async function loadStores(){
    storesData=await api('/api/stores')||[];
    const list=document.getElementById('storesList');
    if(!storesData.length){list.innerHTML='<div style="text-align:center;padding:40px;color:var(--text-mid)">No hay tiendas. Crea tu primera tienda.</div>';return;}
    list.innerHTML=storesData.map(s=>`
        <div class="store-card" onclick="showStoreDetail('${s.id}')">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
                <div><div class="store-card-name" style="color:${s.primary_color||'var(--accent)'};">${s.name}</div>
                <div style="font-size:12px;color:var(--text-mid);">${s.email||''} ${s.phone?'Â· '+s.phone:''} ${s.instagram?'Â· @'+s.instagram:''}</div></div>
                <div style="display:flex;gap:6px;align-items:center;">
                    <span class="badge badge-foto">${s.garment_count||0} prendas</span>
                    <button class="btn btn-danger btn-sm" onclick="event.stopPropagation();deleteStore('${s.id}')">âœ•</button>
                </div>
            </div>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;font-size:12px;">
                <div><span style="color:var(--text-mid);">ğŸ‘¥ Clientes:</span> <a href="/tienda/${s.slug}" target="_blank" style="color:var(--accent);" onclick="event.stopPropagation();">/tienda/${s.slug}</a></div>
                <div><span style="color:var(--text-mid);">ğŸª Panel:</span> <a href="/panel/${s.slug}" target="_blank" style="color:var(--blue);" onclick="event.stopPropagation();">/panel/${s.slug}</a> <span style="color:var(--text-dim);margin-left:6px;">ğŸ” ${s.panel_password||'â€”'}</span></div>
            </div>
        </div>`).join('');
}

async function showStoreDetail(storeId){
    selectedStoreId=storeId;
    if(!storesData.length) storesData=await api('/api/stores')||[];
    const store=storesData.find(s=>s.id===storeId); if(!store)return;
    document.getElementById('storeDetailName').textContent=store.name;
    document.getElementById('storeAccessLinks').innerHTML=`
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;font-size:13px;">
            <div><div style="color:var(--text-mid);margin-bottom:4px;">ğŸ‘¥ Link para clientes:</div>
                <div style="display:flex;align-items:center;gap:4px;"><a href="/tienda/${store.slug}" target="_blank" style="color:var(--accent);font-weight:600;">${location.origin}/tienda/${store.slug}</a><button class="copy-btn" onclick="copyText('${location.origin}/tienda/${store.slug}',this)">ğŸ“‹</button></div></div>
            <div><div style="color:var(--text-mid);margin-bottom:4px;">ğŸª Panel del dueÃ±o:</div>
                <div style="display:flex;align-items:center;gap:4px;"><a href="/panel/${store.slug}" target="_blank" style="color:var(--blue);font-weight:600;">${location.origin}/panel/${store.slug}</a><button class="copy-btn" onclick="copyText('${location.origin}/panel/${store.slug}',this)">ğŸ“‹</button></div>
                <div style="margin-top:4px;"><span style="color:var(--text-mid);">ğŸ”</span> <code style="background:var(--bg);padding:2px 8px;border-radius:4px;color:var(--accent);font-weight:600;">${store.panel_password||'â€”'}</code><button class="copy-btn" onclick="copyText('${store.panel_password||''}',this)">ğŸ“‹</button></div></div>
        </div>`;
    document.getElementById('storeDetailInfo').innerHTML=`
        <div class="section"><div class="section-title">InformaciÃ³n</div>
            <div class="info-row"><span class="info-label">Email</span><span class="info-value">${store.email||'â€”'}</span></div>
            <div class="info-row"><span class="info-label">TelÃ©fono</span><span class="info-value">${store.phone||'â€”'}</span></div>
            <div class="info-row"><span class="info-label">Instagram</span><span class="info-value">${store.instagram?'@'+store.instagram:'â€”'}</span></div>
            <div class="info-row"><span class="info-label">Website</span><span class="info-value">${store.website||'â€”'}</span></div></div>
        <div class="section"><div class="section-title">Tarifas</div>
            <div class="info-row"><span class="info-label">Precio outfit</span><span class="info-value">${COP(store.price_per_outfit||0)}</span></div>
            <div class="info-row"><span class="info-label">Precio video</span><span class="info-value">${COP(store.price_per_video||0)}</span></div>
            <div class="info-row"><span class="info-label">DirecciÃ³n</span><span class="info-value">${store.address||'â€”'}</span></div>
            <div class="info-row"><span class="info-label">Creada</span><span class="info-value">${store.created_at?.slice(0,10)||'â€”'}</span></div></div>`;
    // Stats from clients API
    try{const data=await api('/api/admin/clients');const c=(data.clients||[]).find(c=>c.id===storeId);
        if(c){document.getElementById('storeDetailStats').innerHTML=[
            {label:'CrÃ©ditos usados',value:c.stats.total_credits,cls:'accent'},{label:'Tu costo',value:COP(c.stats.cost_cop),cls:'red'},
            {label:'Cobrar',value:COP(c.stats.charge_cop),cls:'green'},{label:'Ganancia',value:COP(c.stats.profit_cop),cls:'blue'},
        ].map(s=>`<div class="stat-card"><div class="stat-label">${s.label}</div><div class="stat-value ${s.cls}">${s.value}</div></div>`).join('');}
        else document.getElementById('storeDetailStats').innerHTML='';
    }catch(e){document.getElementById('storeDetailStats').innerHTML='';}
    // Logs
    try{const logs=await api(`/api/admin/usage?client_id=${storeId}`);const sl=logs.logs||[];
        document.getElementById('storeDetailLogs').innerHTML=sl.map(l=>`<tr><td style="color:var(--text-mid)">${l.created_at?.slice(0,10)||''}</td><td><span class="badge ${l.usage_type==='tryon'?'badge-foto':'badge-video'}">${l.usage_type==='tryon'?'ğŸ“·':'ğŸ¬'}</span></td><td>${l.garments_desc||'â€”'}</td><td style="color:var(--accent);font-weight:600">${l.credits_used}</td><td style="color:var(--red)">${COP(l.cost_cop)}</td><td style="color:var(--green);font-weight:600">${COP(l.charge_cop)}</td><td style="font-size:12px;color:var(--text-mid)">${l.notes||''}</td><td><button class="btn btn-danger btn-sm" onclick="deleteLog('${l.id}','${storeId}')">âœ•</button></td></tr>`).join('')||'<tr><td colspan="8" style="text-align:center;color:var(--text-mid);padding:20px">Sin registros</td></tr>';
    }catch(e){document.getElementById('storeDetailLogs').innerHTML='<tr><td colspan="8" style="text-align:center;color:var(--text-mid);padding:20px">Sin registros</td></tr>';}
    document.getElementById('storeLinkBtn').href=`/tienda/${store.slug}`;
    showTab('store-detail'); loadStoreGarments(storeId);
}

async function loadStoreGarments(storeId){
    const data=await api(`/api/catalog?store_id=${storeId}`);const garments=data.garments||[];const grid=document.getElementById('storeGarments');
    if(!garments.length){grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:30px;color:var(--text-mid);font-size:13px;">Sin prendas. Haz clic en "Subir prenda".</div>';return;}
    grid.innerHTML=garments.map(g=>{const icon=g.category==='tops'?'ğŸ‘•':g.category==='bottoms'?'ğŸ‘–':'ğŸ‘—';const on=g.tryon_enabled;
        const st=on?'background:var(--green-soft);color:var(--green);border:1px solid var(--green);':'background:var(--surface);color:var(--text-mid);border:1px solid var(--border);';
        return`<div style="background:var(--surface);border:1px solid ${on?'var(--green)':'var(--border)'};border-radius:10px;overflow:hidden;position:relative;">
            ${on?'<div style="position:absolute;top:6px;right:6px;background:var(--green);color:#fff;padding:2px 6px;border-radius:8px;font-size:9px;font-weight:600;">âœ¨ Try-On</div>':''}
            <img src="${g.image_url}" style="width:100%;height:130px;object-fit:cover;background:#111;">
            <div style="padding:8px 10px;"><div style="font-weight:600;font-size:12px;">${icon} ${g.name}</div>
                <div style="font-size:11px;color:var(--text-mid);margin-top:2px;">${g.size}${g.reference?' Â· '+g.reference:''}</div>
                ${g.price?`<div style="font-size:12px;color:var(--accent);font-weight:600;margin-top:2px;">$${Number(g.price).toLocaleString('es-CO')}</div>`:''}
                <button onclick="toggleTryon('${g.id}',${!on})" style="width:100%;margin-top:6px;padding:5px;border-radius:6px;font-size:10px;cursor:pointer;font-weight:600;${st}">${on?'âœ¨ Probador Activo':'â—‹ Activar Probador'}</button>
                <div style="display:flex;gap:4px;margin-top:4px;">
                    <a href="/api/garment/${g.id}/qr" download style="flex:1;text-align:center;padding:4px;background:var(--blue-soft);color:var(--blue);border:1px solid var(--blue);border-radius:6px;font-size:10px;text-decoration:none;">ğŸ“± QR</a>
                    <a href="/prenda/${g.id}" target="_blank" style="flex:1;text-align:center;padding:4px;background:var(--card);border:1px solid var(--border);border-radius:6px;font-size:10px;text-decoration:none;color:var(--text);">ğŸ‘ï¸</a>
                    <button onclick="editGarmentCategory('${g.id}','${g.category}')" style="flex:0.7;padding:4px;background:var(--accent-soft);color:var(--accent);border:1px solid var(--accent);border-radius:6px;font-size:10px;cursor:pointer;">âœï¸</button>
                    <button onclick="deleteGarment('${g.id}')" style="flex:0.5;padding:4px;background:var(--red-soft);color:var(--red);border:1px solid var(--red);border-radius:6px;font-size:10px;cursor:pointer;">âœ•</button>
                </div></div></div>`;}).join('');
}

// â•â•â• STORE CRUD â•â•â•
async function createStore(){
    const form=new FormData();
    ['name','slug','phone','email'].forEach((f,i)=>form.append(f,document.getElementById(['newStoreName','newStoreSlug','newStorePhone','newStoreEmail'][i]).value));
    form.append('instagram',document.getElementById('newStoreIG').value);
    form.append('website',document.getElementById('newStoreWeb').value);
    form.append('primary_color',document.getElementById('newStoreColor').value);
    form.append('panel_password',document.getElementById('newStorePass').value);
    form.append('address',document.getElementById('newStoreAddr').value);
    form.append('price_per_outfit',document.getElementById('newStoreOutfit').value);
    form.append('price_per_video',document.getElementById('newStoreVideo').value);
    const logo=document.getElementById('newStoreLogo');if(logo.files&&logo.files[0])form.append('logo',logo.files[0]);
    try{const resp=await fetch('/api/store',{method:'POST',body:form});const data=await resp.json();
        if(data.success){closeModal();alert(`âœ… Tienda creada!\n\nğŸ” ContraseÃ±a: ${data.store.panel_password}\nğŸª Panel: /panel/${data.store.slug}\nğŸ‘¥ Tienda: /tienda/${data.store.slug}`);
            ['newStoreName','newStoreSlug','newStorePhone','newStoreEmail','newStoreIG','newStoreWeb','newStorePass','newStoreAddr'].forEach(id=>document.getElementById(id).value='');loadStores();}
        else alert('Error: '+(data.detail||JSON.stringify(data)));
    }catch(e){alert('Error de conexiÃ³n');}
}
async function deleteStore(id){if(!confirm('Â¿Eliminar esta tienda?'))return;await api(`/api/store/${id}`,'DELETE');loadStores();}

// â•â•â• GARMENT CRUD â•â•â•
async function uploadGarment(){
    const f=document.getElementById('gcImage');if(!f.files||!f.files[0]){alert('Selecciona foto');return;}
    const name=document.getElementById('gcName').value,cat=document.getElementById('gcCategory').value;
    if(!name||!cat){alert('Nombre y categorÃ­a obligatorios');return;}
    const form=new FormData();form.append('name',name);form.append('category',cat);
    form.append('gender',document.getElementById('gcGender').value);form.append('size',document.getElementById('gcSize').value);
    form.append('price',document.getElementById('gcPrice').value||'0');form.append('image',f.files[0]);
    form.append('store_id',selectedStoreId);form.append('reference',document.getElementById('gcRef').value||'');
    form.append('color',document.getElementById('gcColor').value||'');form.append('material',document.getElementById('gcMaterial').value||'');
    try{const resp=await fetch('/api/upload-garment',{method:'POST',body:form});const data=await resp.json();
        if(data.success){closeModal();['gcName','gcRef','gcColor','gcMaterial'].forEach(id=>document.getElementById(id).value='');document.getElementById('gcPrice').value='0';f.value='';loadStoreGarments(selectedStoreId);}
        else alert('Error: '+(data.detail||'Error'));
    }catch(e){alert('Error de conexiÃ³n');}
}
async function deleteGarment(id){if(!confirm('Â¿Eliminar?'))return;await api(`/api/garment/${id}`,'DELETE');loadStoreGarments(selectedStoreId);}
async function toggleTryon(id,enable){const form=new FormData();form.append('tryon_enabled',enable?'true':'false');await fetch(`/api/garment/${id}`,{method:'PUT',body:form});loadStoreGarments(selectedStoreId);}
async function editGarmentCategory(id,cur){const n=prompt(`CategorÃ­a actual: ${cur}\n\ntops / bottoms / one-pieces`);if(!n||!['tops','bottoms','one-pieces'].includes(n.trim())){if(n!==null)alert('InvÃ¡lida');return;}const form=new FormData();form.append('category',n.trim());await fetch(`/api/garment/${id}`,{method:'PUT',body:form});loadStoreGarments(selectedStoreId);}
function downloadAllQR(){window.open(`/api/garments/qr-all?store_id=${selectedStoreId}`,'_blank');}

// â•â•â• DASHBOARD â•â•â•
async function loadDashboard(){
    dashData=await api('/api/admin/dashboard');const credits=await api('/api/credits');
    let cred=credits?.credits?.total??credits?.credits?.remaining??'?';
    document.getElementById('fashnCredits').textContent=cred;document.getElementById('creditsOverview').textContent=cred;
    document.getElementById('statFotos').textContent=dashData.total_fotos||0;document.getElementById('statVideos').textContent=dashData.total_videos||0;
    document.getElementById('planSelect').value=dashData.plan||'tier1';
    document.getElementById('overviewStats').innerHTML=[
        {label:'CrÃ©ditos usados',value:dashData.total_credits,cls:'accent'},{label:'Costo FASHN',value:COP(dashData.total_cost_cop),cls:'red'},
        {label:'Ingresos',value:COP(dashData.total_charge_cop),cls:'green'},{label:'Ganancia neta',value:COP(dashData.total_profit_cop),cls:'blue'},
    ].map(s=>`<div class="stat-card"><div class="stat-label">${s.label}</div><div class="stat-value ${s.cls}">${s.value}</div></div>`).join('');
}

// â•â•â• QR â•â•â•
async function loadQRCodes(){
    const data=await api('/api/catalog');const garments=data.garments||[];const grid=document.getElementById('qr-grid');
    if(!garments.length){grid.innerHTML='<p style="color:var(--text-mid);">No hay prendas.</p>';return;}
    grid.innerHTML=garments.map(g=>{const icon=g.category==='tops'?'ğŸ‘•':g.category==='bottoms'?'ğŸ‘–':'ğŸ‘—';
        return`<div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;text-align:center;">
            <a href="/api/garment/${g.id}/qr" download><img src="/api/garment/${g.id}/qr" style="width:100%;cursor:pointer;"></a>
            <div style="padding:10px;"><div style="font-weight:600;font-size:13px;">${icon} ${g.name}</div>
            <div style="display:flex;gap:6px;margin-top:8px;">
                <a href="/api/garment/${g.id}/qr" download class="btn btn-primary" style="flex:1;text-decoration:none;font-size:11px;padding:6px;">â¬‡ï¸</a>
                <a href="/prenda/${g.id}" target="_blank" class="btn btn-secondary" style="flex:1;font-size:11px;padding:6px;text-decoration:none;">ğŸ‘ï¸</a></div></div></div>`;}).join('');
}

// â•â•â• BILLING â•â•â•
async function loadBilling(){
    const data=await api('/api/admin/clients');const clients=data.clients||[];
    let tF=0,tV=0,tCr=0,tCo=0,tCh=0,tPr=0;
    document.getElementById('billingTable').innerHTML=clients.map(c=>{const s=c.stats;tF+=s.fotos;tV+=s.videos;tCr+=s.total_credits;tCo+=s.cost_cop;tCh+=s.charge_cop;tPr+=s.profit_cop;
        const m=s.charge_cop>0?Math.round(s.profit_cop/s.charge_cop*100):0;
        return`<tr><td style="font-weight:500">${c.name}</td><td style="text-align:center">${s.fotos}</td><td style="text-align:center">${s.videos}</td><td style="text-align:center;color:var(--accent);font-weight:600">${s.total_credits}</td><td style="text-align:right;color:var(--red)">${COP(s.cost_cop)}</td><td style="text-align:right;color:var(--green);font-weight:600">${COP(s.charge_cop)}</td><td style="text-align:right;color:var(--blue);font-weight:700">${COP(s.profit_cop)}</td><td style="text-align:right"><span class="badge badge-margin-${m>70?'high':m>40?'mid':'low'}">${m}%</span></td></tr>`;}).join('');
    const tm=tCh>0?Math.round(tPr/tCh*100):0;
    document.getElementById('billingTotals').innerHTML=`<tr><td>TOTAL</td><td style="text-align:center">${tF}</td><td style="text-align:center">${tV}</td><td style="text-align:center;color:var(--accent)">${tCr}</td><td style="text-align:right;color:var(--red)">${COP(tCo)}</td><td style="text-align:right;color:var(--green)">${COP(tCh)}</td><td style="text-align:right;color:var(--blue);font-size:15px">${COP(tPr)}</td><td style="text-align:right"><span class="badge badge-margin-high">${tm}%</span></td></tr>`;
}

// â•â•â• ACTIVITY â•â•â•
async function loadActivity(){
    const data=await api('/api/admin/usage');logsData=data.logs||[];
    document.getElementById('activityTable').innerHTML=logsData.map(l=>`<tr><td style="color:var(--text-mid)">${l.created_at?.slice(0,10)||''}</td><td>${l.client_name}</td><td><span class="badge ${l.usage_type==='tryon'?'badge-foto':'badge-video'}">${l.usage_type==='tryon'?'ğŸ“·':'ğŸ¬'}</span></td><td>${l.garments_desc||'â€”'}</td><td style="color:var(--accent);font-weight:600">${l.credits_used}</td><td style="color:var(--red)">${COP(l.cost_cop)}</td><td style="color:var(--green);font-weight:600">${COP(l.charge_cop)}</td><td style="font-size:12px;color:var(--text-mid)">${l.notes||''}</td><td><button class="btn btn-danger btn-sm" onclick="deleteLog('${l.id}')">âœ•</button></td></tr>`).join('')||'<tr><td colspan="9" style="text-align:center;color:var(--text-mid);padding:20px">Sin registros</td></tr>';
}

// â•â•â• USAGE â•â•â•
async function createUsage(){
    const ut=document.getElementById('usageType').value;let cr=1;
    if(ut==='tryon')cr=parseInt(document.getElementById('usageCredits').value);else if(ut==='video-720p')cr=3;else if(ut==='video-1080p')cr=6;
    const body=new FormData();body.append('client_id',document.getElementById('usageStore').value);
    body.append('usage_type',ut);body.append('credits_used',cr);body.append('garments_desc',document.getElementById('usageGarments').value);body.append('notes',document.getElementById('usageNotes').value);
    const res=await api('/api/admin/usage','POST',body);
    if(res.success){closeModal();document.getElementById('usageGarments').value='';document.getElementById('usageNotes').value='';if(selectedStoreId)showStoreDetail(selectedStoreId);else loadActivity();}
}
async function deleteLog(id,sid){if(!confirm('Â¿Eliminar?'))return;await api(`/api/admin/usage/${id}`,'DELETE');if(sid)showStoreDetail(sid);else loadActivity();}
function populateStoreSelect(){
    const sel=document.getElementById('usageStore');
    sel.innerHTML='<option value="">Seleccionar...</option>'+storesData.map(s=>`<option value="${s.id}" ${s.id===selectedStoreId?'selected':''}>${s.name}</option>`).join('');
}
document.getElementById('usageType').addEventListener('change',function(){document.getElementById('creditsGroup').style.display=this.value==='tryon'?'block':'none';});
async function updatePlan(){const form=new FormData();form.append('fashn_plan',document.getElementById('planSelect').value);await api('/api/admin/settings','PUT',form);loadDashboard();}

// â•â•â• INIT â•â•â•
loadDashboard();
</script>
</body>
</html>
